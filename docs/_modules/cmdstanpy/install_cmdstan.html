
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cmdstanpy.install_cmdstan &#8212; CmdStanPy 1.2.4 documentation</title>
    
    <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/project-template.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    
    <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
<link rel="stylesheet" href="_static/basic.css" type="text/css" />

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
<nav id="navbar-main" class="navbar navbar-dark navbar-expand-lg fixed-top bd-navbar"
    style="background-color: #222222;"><div class="container-xl">

  <div id="navbar-start">
    
    <!-- This will display the version of the docs -->
<a class='navbar-brand' href='../../index.html'>CmdStanPy 1.2.4</a>
    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../users-guide.html">
  User’s Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api.html">
  API Reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../changes.html">
  What’s New
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../community.html">
  Community
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/mcmc_stan" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/stan-dev/cmdstanpy" rel="noopener" target="_blank" title="GitHub"><span><i class="fab fa-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://discourse.mc-stan.org/" rel="noopener" target="_blank" title="Forums"><span><i class="fas fa-users"></i></span>
            <label class="sr-only">Forums</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
</nav>


    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for cmdstanpy.install_cmdstan</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Download and install a CmdStan release from GitHub.</span>
<span class="sd">Downloads the release tar.gz file to temporary storage.</span>
<span class="sd">Retries GitHub requests in order to allow for transient network outages.</span>
<span class="sd">Builds CmdStan executables and tests the compiler by building</span>
<span class="sd">example model ``bernoulli.stan``.</span>

<span class="sd">Optional command line arguments:</span>
<span class="sd">   -i, --interactive: flag, when specified ignore other arguments and</span>
<span class="sd">                      ask user for settings on STDIN</span>
<span class="sd">   -v, --version &lt;release&gt; : version, defaults to latest release version</span>
<span class="sd">   -d, --dir &lt;path&gt; : install directory, defaults to &#39;$HOME/.cmdstan</span>
<span class="sd">   --overwrite: flag, when specified re-installs existing version</span>
<span class="sd">   --progress: flag, when specified show progress bar for CmdStan download</span>
<span class="sd">   --verbose: flag, when specified prints output from CmdStan build process</span>
<span class="sd">   --cores: int, number of cores to use when building, defaults to 1</span>
<span class="sd">   -c, --compiler : flag, add C++ compiler to path (Windows only)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">urllib.error</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">cmdstanpy</span> <span class="kn">import</span> <span class="n">_DOT_CMDSTAN</span>
<span class="kn">from</span> <span class="nn">cmdstanpy.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">cmdstan_path</span><span class="p">,</span>
    <span class="n">do_command</span><span class="p">,</span>
    <span class="n">pushd</span><span class="p">,</span>
    <span class="n">validate_dir</span><span class="p">,</span>
    <span class="n">wrap_url_progress_hook</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cmdstanpy.utils.cmdstan</span> <span class="kn">import</span> <span class="n">get_download_url</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">progress</span> <span class="k">as</span> <span class="n">progbar</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="ow">or</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="c1"># mypy only knows about the new built-in cached_property</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">cached_property</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># on older Python versions, this is the recommended</span>
    <span class="c1"># way to get the same effect</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>

    <span class="k">def</span> <span class="nf">cached_property</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">property</span><span class="p">(</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="kc">None</span><span class="p">)(</span><span class="n">fun</span><span class="p">))</span>


<span class="k">try</span><span class="p">:</span>
    <span class="c1"># on MacOS and Linux, importing this</span>
    <span class="c1"># improves the UX of the input() function</span>
    <span class="kn">import</span> <span class="nn">readline</span>

    <span class="c1"># dummy statement to use import for flake8/pylint</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">readline</span><span class="o">.</span><span class="vm">__doc__</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">CmdStanRetrieveError</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">CmdStanInstallError</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">is_windows</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span>


<span class="n">MAKE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MAKE&#39;</span><span class="p">,</span> <span class="s1">&#39;make&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_windows</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;mingw32-make&#39;</span><span class="p">)</span>
<span class="n">EXTENSION</span> <span class="o">=</span> <span class="s1">&#39;.exe&#39;</span> <span class="k">if</span> <span class="n">is_windows</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>


<span class="k">def</span> <span class="nf">get_headers</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create headers dictionary.&quot;&quot;&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">GITHUB_PAT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GITHUB_PAT&quot;</span><span class="p">)</span>  <span class="c1"># pylint:disable=invalid-name</span>
    <span class="k">if</span> <span class="n">GITHUB_PAT</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;token </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">GITHUB_PAT</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">headers</span>


<span class="k">def</span> <span class="nf">latest_version</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Report latest CmdStan release version.&quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://api.github.com/repos/stan-dev/cmdstan/releases/latest&#39;</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">get_headers</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot connect to github.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;retry (</span><span class="si">{}</span><span class="s1">/5)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">raise</span> <span class="n">CmdStanRetrieveError</span><span class="p">(</span>
                <span class="s1">&#39;Cannot connect to CmdStan github repo.&#39;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;tag_name&#39;</span><span class="p">]</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;v?(.+)&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tag</span>  <span class="c1"># type: ignore</span>


<span class="k">def</span> <span class="nf">home_cmdstan</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">,</span> <span class="n">_DOT_CMDSTAN</span><span class="p">))</span>


<span class="c1"># pylint: disable=too-few-public-methods</span>
<span class="k">class</span> <span class="nc">InstallationSettings</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A static installation settings object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">compiler</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span> <span class="k">if</span> <span class="n">version</span> <span class="k">else</span> <span class="n">latest_version</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="nb">dir</span> <span class="k">if</span> <span class="nb">dir</span> <span class="k">else</span> <span class="n">home_cmdstan</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="n">overwrite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="o">=</span> <span class="n">cores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span> <span class="o">=</span> <span class="n">compiler</span> <span class="ow">and</span> <span class="n">is_windows</span><span class="p">()</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">kwargs</span>  <span class="c1"># ignore all other inputs.</span>
        <span class="c1"># Useful if initialized from a dictionary like **dict</span>


<span class="k">def</span> <span class="nf">yes_no</span><span class="p">(</span><span class="n">answer</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="n">answer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">answer</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">answer</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">default</span>


<span class="k">class</span> <span class="nc">InteractiveSettings</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Installation settings provided on-demand in an interactive format.</span>

<span class="sd">    This provides the same set of properties as the ``InstallationSettings``</span>
<span class="sd">    object, but rather than them being fixed by the constructor the user is</span>
<span class="sd">    asked for input whenever they are accessed for the first time.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">latest_version</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Which version would you like to install?&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default: </span><span class="si">{</span><span class="n">latest</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Type version or hit enter to continue: &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">answer</span> <span class="k">if</span> <span class="n">answer</span> <span class="k">else</span> <span class="n">latest</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">home_cmdstan</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Where would you like to install CmdStan?&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default: </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Type full path or hit enter to continue: &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span> <span class="k">if</span> <span class="n">answer</span> <span class="k">else</span> <span class="n">directory</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">progress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Show installation progress bars?&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Default: y&quot;</span><span class="p">)</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;[y/n]: &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">yes_no</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">verbose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Show verbose output of the installation process?&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Default: n&quot;</span><span class="p">)</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;[y/n]: &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">yes_no</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">overwrite</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Overwrite existing CmdStan installation?&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Default: n&quot;</span><span class="p">)</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;[y/n]: &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">yes_no</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">compiler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_windows</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Would you like to install the RTools40 C++ toolchain?&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A C++ toolchain is required for CmdStan.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;If you are not sure if you need the toolchain or not, &quot;</span>
            <span class="s2">&quot;the most likely case is you do need it, and should answer &#39;y&#39;.&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Default: n&quot;</span><span class="p">)</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;[y/n]: &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">yes_no</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">cores</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">max_cpus</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;How many CPU cores would you like to use for installing &quot;</span>
            <span class="s2">&quot;and compiling CmdStan?&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default: 1, Max: </span><span class="si">{</span><span class="n">max_cpus</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter a number or hit enter to continue: &quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_cpus</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">answer</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">clean_all</span><span class="p">(</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run `make clean-all` in the current directory (must be a cmdstan library).</span>

<span class="sd">    :param verbose: Boolean value; when ``True``, show output from make command.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">MAKE</span><span class="p">,</span> <span class="s1">&#39;clean-all&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">do_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">do_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">fd_out</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># pylint: disable=raise-missing-from</span>
        <span class="k">raise</span> <span class="n">CmdStanInstallError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Command &quot;make clean-all&quot; failed</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run command ``make build`` in the current directory, which must be</span>
<span class="sd">    the home directory of a CmdStan version (or GitHub repo).</span>
<span class="sd">    By default, displays a progress bar which tracks make command outputs.</span>
<span class="sd">    If argument ``verbose=True``, instead of a progress bar, streams</span>
<span class="sd">    make command outputs to sys.stdout.  When both ``verbose`` and ``progress``</span>
<span class="sd">    are ``False``, runs silently.</span>

<span class="sd">    :param verbose: Boolean value; when ``True``, show output from make command.</span>
<span class="sd">        Default is ``False``.</span>
<span class="sd">    :param progress: Boolean value; when ``True`` display progress progress bar.</span>
<span class="sd">        Default is ``True``.</span>
<span class="sd">    :param cores: Integer, number of cores to use in the ``make`` command.</span>
<span class="sd">        Default is 1 core.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">MAKE</span><span class="p">,</span> <span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;-j</span><span class="si">{</span><span class="n">cores</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">do_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">progress</span> <span class="ow">and</span> <span class="n">progbar</span><span class="o">.</span><span class="n">allow_show_progress</span><span class="p">():</span>
            <span class="n">progress_hook</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">_wrap_build_progress_hook</span><span class="p">()</span>
            <span class="n">do_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">fd_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="n">progress_hook</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">do_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">fd_out</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># pylint: disable=raise-missing-from</span>
        <span class="k">raise</span> <span class="n">CmdStanInstallError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Command &quot;make build&quot; failed</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;bin&#39;</span><span class="p">,</span> <span class="s1">&#39;stansummary&#39;</span> <span class="o">+</span> <span class="n">EXTENSION</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">CmdStanInstallError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;bin/stansummary</span><span class="si">{</span><span class="n">EXTENSION</span><span class="si">}</span><span class="s1"> not found&#39;</span>
            <span class="s1">&#39;, please rebuild or report a bug!&#39;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;bin&#39;</span><span class="p">,</span> <span class="s1">&#39;diagnose&#39;</span> <span class="o">+</span> <span class="n">EXTENSION</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">CmdStanInstallError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;bin/stansummary</span><span class="si">{</span><span class="n">EXTENSION</span><span class="si">}</span><span class="s1"> not found&#39;</span>
            <span class="s1">&#39;, please rebuild or report a bug!&#39;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">is_windows</span><span class="p">():</span>
        <span class="c1"># Add tbb to the $PATH on Windows</span>
        <span class="n">libtbb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;stan&#39;</span><span class="p">,</span> <span class="s1">&#39;lib&#39;</span><span class="p">,</span> <span class="s1">&#39;stan_math&#39;</span><span class="p">,</span> <span class="s1">&#39;lib&#39;</span><span class="p">,</span> <span class="s1">&#39;tbb&#39;</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span>
                <span class="n">OrderedDict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">libtbb</span><span class="p">]</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>


<span class="nd">@progbar</span><span class="o">.</span><span class="n">wrap_callback</span>
<span class="k">def</span> <span class="nf">_wrap_build_progress_hook</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sets up tqdm callback for CmdStan sampler console msgs.&quot;&quot;&quot;</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">20</span>
    <span class="n">msgs_expected</span> <span class="o">=</span> <span class="mi">150</span>  <span class="c1"># hack: 2.27 make build send ~140 msgs to console</span>
    <span class="n">pbar</span><span class="p">:</span> <span class="n">tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="n">total</span><span class="o">=</span><span class="n">msgs_expected</span><span class="p">,</span>
        <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{desc}</span><span class="s2"> (</span><span class="si">{elapsed}</span><span class="s2">) | </span><span class="si">{bar}</span><span class="s2"> | </span><span class="si">{postfix[0][value]}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">postfix</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Building CmdStan </span><span class="si">{</span><span class="n">pad</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}],</span>
        <span class="n">colour</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
        <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_progress_hook</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;--- CmdStan&#39;</span><span class="p">):</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">postfix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">msgs_expected</span> <span class="o">-</span> <span class="n">pbar</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">):</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">postfix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">postfix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">line</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s1"> ... </span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">:]</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s1">&#39;Compiling&#39;</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">build_progress_hook</span>


<span class="k">def</span> <span class="nf">compile_example</span><span class="p">(</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compile the example model.</span>
<span class="sd">    The current directory must be a cmdstan installation, i.e.,</span>
<span class="sd">    contains the makefile, Stanc compiler, and all libraries.</span>

<span class="sd">    :param verbose: Boolean value; when ``True``, show output from make command.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;examples&#39;</span><span class="p">,</span> <span class="s1">&#39;bernoulli&#39;</span><span class="p">,</span> <span class="s1">&#39;bernoulli&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">EXTENSION</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">MAKE</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">do_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">do_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">fd_out</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># pylint: disable=raise-missing-from</span>
        <span class="k">raise</span> <span class="n">CmdStanInstallError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Command &quot;</span><span class="si">{</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot; failed:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">CmdStanInstallError</span><span class="p">(</span><span class="s2">&quot;Failed to generate example binary&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="rebuild_cmdstan"><a class="viewcode-back" href="../../api.html#cmdstanpy.rebuild_cmdstan">[docs]</a><span class="k">def</span> <span class="nf">rebuild_cmdstan</span><span class="p">(</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rebuilds the existing CmdStan installation.</span>
<span class="sd">    This assumes CmdStan has already been installed,</span>
<span class="sd">    though it need not be installed via CmdStanPy for</span>
<span class="sd">    this function to work.</span>

<span class="sd">    :param verbose: Boolean value; when ``True``, show output from make command.</span>
<span class="sd">        Default is ``False``.</span>
<span class="sd">    :param progress: Boolean value; when ``True`` display progress progress bar.</span>
<span class="sd">        Default is ``True``.</span>
<span class="sd">    :param cores: Integer, number of cores to use in the ``make`` command.</span>
<span class="sd">        Default is 1 core.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">pushd</span><span class="p">(</span><span class="n">cmdstan_path</span><span class="p">()):</span>
            <span class="n">clean_all</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">build</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">cores</span><span class="p">)</span>
            <span class="n">compile_example</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CmdStanInstallError</span><span class="p">(</span>
            <span class="s2">&quot;Failed to rebuild CmdStan. Are you sure it is installed?&quot;</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span></div>


<span class="k">def</span> <span class="nf">install_version</span><span class="p">(</span>
    <span class="n">cmdstan_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build specified CmdStan version by spawning subprocesses to</span>
<span class="sd">    run the Make utility on the downloaded CmdStan release src files.</span>
<span class="sd">    Assumes that current working directory is parent of release dir.</span>

<span class="sd">    :param cmdstan_version: CmdStan release, corresponds to release dirname.</span>
<span class="sd">    :param overwrite: when ``True``, run ``make clean-all`` before building.</span>
<span class="sd">    :param verbose: Boolean value; when ``True``, show output from make command.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pushd</span><span class="p">(</span><span class="n">cmdstan_version</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;Building version </span><span class="si">{}</span><span class="s1">, may take several minutes, &#39;</span>
            <span class="s1">&#39;depending on your system.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmdstan_version</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;Overwrite requested, remove existing build of version &#39;</span>
                <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmdstan_version</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">clean_all</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Rebuilding version </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmdstan_version</span><span class="p">))</span>
        <span class="n">build</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="n">cores</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Installed </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmdstan_version</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">is_version_available</span><span class="p">(</span><span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39;git:&#39;</span> <span class="ow">in</span> <span class="n">version</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># no good way in general to check if a git tag exists</span>

    <span class="n">is_available</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">get_download_url</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Release </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s1"> is unavailable from URL </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;HTTPError: </span><span class="si">{</span><span class="n">err</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">is_available</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;checking version </span><span class="si">{}</span><span class="s1"> availability, retry (</span><span class="si">{}</span><span class="s1">/5)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">version</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Release </span><span class="si">{}</span><span class="s1"> is unavailable from URL </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;URLError: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
            <span class="n">is_available</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">is_available</span>


<span class="k">def</span> <span class="nf">retrieve_version</span><span class="p">(</span><span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download specified CmdStan version.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Argument &quot;version&quot; unspecified.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;git:&#39;</span> <span class="ow">in</span> <span class="n">version</span><span class="p">:</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tag_folder</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cloning CmdStan branch &#39;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&#39; from stan-dev/cmdstan on GitHub&quot;</span><span class="p">)</span>
        <span class="n">do_command</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s1">&#39;git&#39;</span><span class="p">,</span>
                <span class="s1">&#39;clone&#39;</span><span class="p">,</span>
                <span class="s1">&#39;--depth&#39;</span><span class="p">,</span>
                <span class="s1">&#39;1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;--branch&#39;</span><span class="p">,</span>
                <span class="n">tag</span><span class="p">,</span>
                <span class="s1">&#39;--recursive&#39;</span><span class="p">,</span>
                <span class="s1">&#39;--shallow-submodules&#39;</span><span class="p">,</span>
                <span class="s1">&#39;https://github.com/stan-dev/cmdstan.git&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;cmdstan-</span><span class="si">{</span><span class="n">tag_folder</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Downloading CmdStan version </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="p">))</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">get_download_url</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>  <span class="c1"># always retry to allow for transient URLErrors</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">progress</span> <span class="ow">and</span> <span class="n">progbar</span><span class="o">.</span><span class="n">allow_show_progress</span><span class="p">():</span>
                <span class="n">progress_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
                    <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">wrap_url_progress_hook</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">progress_hook</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">file_tmp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reporthook</span><span class="o">=</span><span class="n">progress_hook</span>
            <span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CmdStanRetrieveError</span><span class="p">(</span>
                <span class="s1">&#39;HTTPError: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;Version </span><span class="si">{}</span><span class="s1"> not available from github.com.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">version</span>
                <span class="p">)</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;Failed to download CmdStan version </span><span class="si">{}</span><span class="s1"> from github.com&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">version</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;retry (</span><span class="si">{}</span><span class="s1">/5)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Version </span><span class="si">{}</span><span class="s1"> not available from github.com.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">CmdStanRetrieveError</span><span class="p">(</span>
                <span class="s1">&#39;Version </span><span class="si">{}</span><span class="s1"> not available from github.com.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Download successful, file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_tmp</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extracting distribution&#39;</span><span class="p">)</span>
        <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_tmp</span><span class="p">)</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">tar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">first</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">top_dir</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">top_dir</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">cmdstan_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;cmdstan-</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">top_dir</span> <span class="o">!=</span> <span class="n">cmdstan_dir</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CmdStanInstallError</span><span class="p">(</span>
                <span class="s1">&#39;tarfile should contain top-level dir </span><span class="si">{}</span><span class="s1">,&#39;</span>
                <span class="s1">&#39;but found dir </span><span class="si">{}</span><span class="s1"> instead.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmdstan_dir</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_windows</span><span class="p">():</span>
            <span class="c1"># fixes long-path limitation on Windows</span>
            <span class="n">target</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">?\</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">progress</span> <span class="ow">and</span> <span class="n">progbar</span><span class="o">.</span><span class="n">allow_show_progress</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">iterable</span><span class="o">=</span><span class="n">tar</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(),</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tar</span><span class="o">.</span><span class="n">getmembers</span><span class="p">()),</span>
                <span class="n">colour</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">tar</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">member</span><span class="o">=</span><span class="n">member</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
        <span class="k">raise</span> <span class="n">CmdStanInstallError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Failed to unpack file </span><span class="si">{</span><span class="n">file_tmp</span><span class="si">}</span><span class="s1">, error:</span><span class="se">\n\t</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unpacked download as </span><span class="si">{</span><span class="n">cmdstan_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">run_compiler_install</span><span class="p">(</span><span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.install_cxx_toolchain</span> <span class="kn">import</span> <span class="n">is_installed</span> <span class="k">as</span> <span class="n">_is_installed_cxx</span>
    <span class="kn">from</span> <span class="nn">.install_cxx_toolchain</span> <span class="kn">import</span> <span class="n">run_rtools_install</span> <span class="k">as</span> <span class="n">_main_cxx</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">cxx_toolchain_path</span>

    <span class="n">compiler_found</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">rtools40_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RTOOLS40_HOME&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cxx_loc</span> <span class="ow">in</span> <span class="p">([</span><span class="n">rtools40_home</span><span class="p">]</span> <span class="k">if</span> <span class="n">rtools40_home</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span>
        <span class="n">home_cmdstan</span><span class="p">(),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span> <span class="s2">&quot;RTools40&quot;</span><span class="p">),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span> <span class="s2">&quot;RTools&quot;</span><span class="p">),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span> <span class="s2">&quot;RTools35&quot;</span><span class="p">),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span> <span class="s2">&quot;RBuildTools&quot;</span><span class="p">),</span>
    <span class="p">]:</span>
        <span class="k">for</span> <span class="n">cxx_version</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;40&#39;</span><span class="p">,</span> <span class="s1">&#39;35&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">_is_installed_cxx</span><span class="p">(</span><span class="n">cxx_loc</span><span class="p">,</span> <span class="n">cxx_version</span><span class="p">):</span>
                <span class="n">compiler_found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">compiler_found</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">compiler_found</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Installing RTools40&#39;</span><span class="p">)</span>
        <span class="c1"># copy argv and clear sys.argv</span>
        <span class="n">_main_cxx</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s1">&#39;dir&#39;</span><span class="p">:</span> <span class="nb">dir</span><span class="p">,</span>
                <span class="s1">&#39;progress&#39;</span><span class="p">:</span> <span class="n">progress</span><span class="p">,</span>
                <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="n">verbose</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">cxx_version</span> <span class="o">=</span> <span class="s1">&#39;40&#39;</span>
    <span class="c1"># Add toolchain to $PATH</span>
    <span class="n">cxx_toolchain_path</span><span class="p">(</span><span class="n">cxx_version</span><span class="p">,</span> <span class="nb">dir</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">run_install</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">InteractiveSettings</span><span class="p">,</span> <span class="n">InstallationSettings</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a (potentially interactive) installation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">validate_dir</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CmdStan install directory: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">))</span>

    <span class="c1"># these accesses just &#39;warm up&#39; the interactive install</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">progress</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">compiler</span><span class="p">:</span>
        <span class="n">run_compiler_install</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;git:&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">cmdstan_version</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;cmdstan-</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmdstan_version</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;cmdstan-</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">with</span> <span class="n">pushd</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">):</span>
        <span class="n">already_installed</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cmdstan_version</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">cmdstan_version</span><span class="p">,</span>
                <span class="s1">&#39;examples&#39;</span><span class="p">,</span>
                <span class="s1">&#39;bernoulli&#39;</span><span class="p">,</span>
                <span class="s1">&#39;bernoulli&#39;</span> <span class="o">+</span> <span class="n">EXTENSION</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">already_installed</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_version_available</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">version</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Installing CmdStan version: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Version </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s1"> cannot be downloaded. &#39;</span>
                    <span class="s1">&#39;Connection to GitHub failed. &#39;</span>
                    <span class="s1">&#39;Check firewall settings or ensure this version exists.&#39;</span>
                <span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">cmdstan_version</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">retrieve_version</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span>
            <span class="n">install_version</span><span class="p">(</span>
                <span class="n">cmdstan_version</span><span class="o">=</span><span class="n">cmdstan_version</span><span class="p">,</span>
                <span class="n">overwrite</span><span class="o">=</span><span class="n">already_installed</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">overwrite</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">progress</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span>
                <span class="n">cores</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">cores</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CmdStan version </span><span class="si">{}</span><span class="s1"> already installed&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>

        <span class="k">with</span> <span class="n">pushd</span><span class="p">(</span><span class="n">cmdstan_version</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test model compilation&#39;</span><span class="p">)</span>
            <span class="n">compile_example</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parse_cmdline_args</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="s2">&quot;install_cmdstan&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--interactive&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-i&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Ignore other arguments and run the installation in &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;interactive mode&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--version&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-v&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;version, defaults to latest release version. &quot;</span>
        <span class="s2">&quot;If git is installed, you can also specify a git tag or branch, &quot;</span>
        <span class="s2">&quot;e.g. git:develop&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--dir&#39;</span><span class="p">,</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;install directory, defaults to &#39;$HOME/.cmdstan&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--overwrite&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;flag, when specified re-installs existing version&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;flag, when specified prints output from CmdStan build process&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--progress&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;flag, when specified show progress bar for CmdStan download&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--cores&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;number of cores to use while building&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">is_windows</span><span class="p">():</span>
        <span class="c1"># use compiler installed with install_cxx_toolchain</span>
        <span class="c1"># Install a new compiler if compiler not found</span>
        <span class="c1"># Search order is RTools40, RTools35</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--compiler&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-c&#39;</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;compiler&#39;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;flag, add C++ compiler to path (Windows only)&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="nb">vars</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>


<span class="k">def</span> <span class="nf">__main__</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_cmdline_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interactive&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">run_install</span><span class="p">(</span><span class="n">InteractiveSettings</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">run_install</span><span class="p">(</span><span class="n">InstallationSettings</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">__main__</span><span class="p">()</span>
</pre></div>

              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2023, Stan Development Team.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>