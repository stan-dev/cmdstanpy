
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cmdstanpy.utils &#8212; CmdStanPy 1.0.2 documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/project-template.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<link rel="stylesheet" href="_static/basic.css" type="text/css" />

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
<nav id="navbar-main" class="navbar navbar-dark navbar-expand-lg fixed-top bd-navbar"
    style="background-color: #222222;"><div class="container-xl">

  <div id="navbar-start">
    
    <!-- This will display the version of the docs -->
<a class='navbar-brand' href='index.html'>CmdStanPy 1.0.2</a>
    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../overview.html">
  Overview
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../hello_world.html">
  “Hello, World!”
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../workflow.html">
  CmdStanPy Workflow
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../examples.html">
  CmdStanPy Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../community.html">
  Community
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api.html">
  API Reference
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/mcmc_stan" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/stan-dev/cmdstanpy" rel="noopener" target="_blank" title="GitHub"><span><i class="fab fa-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://discourse.mc-stan.org/" rel="noopener" target="_blank" title="Forums"><span><i class="fas fa-users"></i></span>
            <label class="sr-only">Forums</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
</nav>


    <div class="container-xl">
      <div class="row">
          
            
            <div class="col-12 col-md-1 col-xl-2 bd-sidebar no-sidebar"></div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-11 col-xl-8 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for cmdstanpy.utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Utility functions</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Collection</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">auto</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Iterator</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Mapping</span><span class="p">,</span>
    <span class="n">MutableMapping</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">TextIO</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">ujson</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">cmdstanpy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_CMDSTAN_SAMPLING</span><span class="p">,</span>
    <span class="n">_CMDSTAN_THIN</span><span class="p">,</span>
    <span class="n">_CMDSTAN_WARMUP</span><span class="p">,</span>
    <span class="n">_DOT_CMDSTAN</span><span class="p">,</span>
    <span class="n">_TMPDIR</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">progress</span> <span class="k">as</span> <span class="n">progbar</span>

<span class="n">EXTENSION</span> <span class="o">=</span> <span class="s1">&#39;.exe&#39;</span> <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>


<span class="k">class</span> <span class="nc">BaseType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stan langauge base type&quot;&quot;&quot;</span>

    <span class="n">COMPLEX</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">PRIM</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>  <span class="c1"># future: int / real</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_logger</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;cmdstanpy logger&quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;cmdstanpy&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># send all messages to handlers</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="c1"># add a default handler to the logger to INFO and higher</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logger</span>


<span class="k">def</span> <span class="nf">validate_dir</span><span class="p">(</span><span class="n">install_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Check that specified install directory exists, can write.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">install_dir</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">install_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="ne">PermissionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Cannot create directory: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">install_dir</span><span class="p">)</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">install_dir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;File exists, should be a directory: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">install_dir</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;tmp_test_w&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;tmp_test_w&#39;</span><span class="p">)</span>  <span class="c1"># cleanup</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Cannot write files to directory </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">install_dir</span><span class="p">)</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>


<span class="k">def</span> <span class="nf">get_latest_cmdstan</span><span class="p">(</span><span class="n">cmdstan_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a valid directory path, find all installed CmdStan versions</span>
<span class="sd">    and return highest (i.e., latest) version number.</span>

<span class="sd">    Assumes directory consists of CmdStan releases, created by</span>
<span class="sd">    function `install_cmdstan`, and therefore dirnames have format</span>
<span class="sd">    &quot;cmdstan-&lt;maj&gt;.&lt;min&gt;.&lt;patch&gt;&quot; or &quot;cmdstan-&lt;maj&gt;.&lt;min&gt;.&lt;patch&gt;-rc&lt;num&gt;&quot;,</span>
<span class="sd">    which is CmdStan release practice as of v 2.24.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">versions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">name</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cmdstan_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmdstan_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cmdstan-&#39;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">name</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span>
        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">versions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># munge rc for sort, e.g. 2.25.0-rc1 -&gt; 2.25.-99</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">versions</span><span class="p">)):</span>  <span class="c1"># # pylint: disable=C0200</span>
        <span class="k">if</span> <span class="s1">&#39;-rc&#39;</span> <span class="ow">in</span> <span class="n">versions</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">comps</span> <span class="o">=</span> <span class="n">versions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-rc&#39;</span><span class="p">)</span>
            <span class="n">mmp</span> <span class="o">=</span> <span class="n">comps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">rc_num</span> <span class="o">=</span> <span class="n">comps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rc_num</span><span class="p">)</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">versions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">mmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">patch</span><span class="p">])</span>

    <span class="n">versions</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))))</span>
    <span class="n">latest</span> <span class="o">=</span> <span class="n">versions</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">versions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># unmunge as needed</span>
    <span class="n">mmp</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">mmp</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">rc_num</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">mmp</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">mmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0-rc&quot;</span> <span class="o">+</span> <span class="n">rc_num</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mmp</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;cmdstan-&#39;</span> <span class="o">+</span> <span class="n">latest</span>


<span class="k">def</span> <span class="nf">validate_cmdstan_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate that CmdStan directory exists and binaries have been built.</span>
<span class="sd">    Throws exception if specified path is invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No CmdStan directory, path </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1"> does not exist.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">,</span> <span class="s1">&#39;stanc&#39;</span> <span class="o">+</span> <span class="n">EXTENSION</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;CmdStan installataion missing binaries. &#39;</span>
            <span class="s1">&#39;Re-install cmdstan by running command &quot;install_cmdstan &#39;</span>
            <span class="s1">&#39;--overwrite&quot;, or Python code &quot;import cmdstanpy; &#39;</span>
            <span class="s1">&#39;cmdstanpy.install_cmdstan(overwrite=True)&quot;&#39;</span>
        <span class="p">)</span>


<div class="viewcode-block" id="set_cmdstan_path"><a class="viewcode-back" href="../../api.html#cmdstanpy.set_cmdstan_path">[docs]</a><span class="k">def</span> <span class="nf">set_cmdstan_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate, then set CmdStan directory path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">validate_cmdstan_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CMDSTAN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span></div>


<div class="viewcode-block" id="set_make_env"><a class="viewcode-back" href="../../api.html#cmdstanpy.set_make_env">[docs]</a><span class="k">def</span> <span class="nf">set_make_env</span><span class="p">(</span><span class="n">make</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    set MAKE environmental variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MAKE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">make</span></div>


<div class="viewcode-block" id="cmdstan_path"><a class="viewcode-back" href="../../api.html#cmdstanpy.cmdstan_path">[docs]</a><span class="k">def</span> <span class="nf">cmdstan_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate, then return CmdStan directory path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmdstan</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;CMDSTAN&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CMDSTAN&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cmdstan</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CMDSTAN&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmdstan_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">,</span> <span class="n">_DOT_CMDSTAN</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cmdstan_dir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;No CmdStan installation found, run command &quot;install_cmdstan&quot;&#39;</span>
                <span class="s1">&#39;or (re)activate your conda environment!&#39;</span>
            <span class="p">)</span>
        <span class="n">latest_cmdstan</span> <span class="o">=</span> <span class="n">get_latest_cmdstan</span><span class="p">(</span><span class="n">cmdstan_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">latest_cmdstan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;No CmdStan installation found, run command &quot;install_cmdstan&quot;&#39;</span>
                <span class="s1">&#39;or (re)activate your conda environment!&#39;</span>
            <span class="p">)</span>
        <span class="n">cmdstan</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmdstan_dir</span><span class="p">,</span> <span class="n">latest_cmdstan</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CMDSTAN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmdstan</span>
    <span class="n">validate_cmdstan_path</span><span class="p">(</span><span class="n">cmdstan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">cmdstan</span><span class="p">)</span></div>


<div class="viewcode-block" id="cmdstan_version"><a class="viewcode-back" href="../../api.html#cmdstanpy.cmdstan_version">[docs]</a><span class="k">def</span> <span class="nf">cmdstan_version</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses version string out of CmdStan makefile variable CMDSTAN_VERSION,</span>
<span class="sd">    returns Tuple(Major, minor).</span>

<span class="sd">    If CmdStan installation is not found or cannot parse version from makefile</span>
<span class="sd">    logs warning and returns None.  Lenient behavoir required for CI tests,</span>
<span class="sd">    per comment:</span>
<span class="sd">    https://github.com/stan-dev/cmdstanpy/pull/321#issuecomment-733817554</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">makefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmdstan_path</span><span class="p">(),</span> <span class="s1">&#39;makefile&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No CmdStan installation found.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">makefile</span><span class="p">):</span>
        <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;CmdStan installation </span><span class="si">%s</span><span class="s1"> missing makefile, cannot get version.&#39;</span><span class="p">,</span>
            <span class="n">cmdstan_path</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">makefile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">start_idx</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;CMDSTAN_VERSION := &#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Cannot parse version from makefile: </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
            <span class="n">makefile</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">start_idx</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="s1">&#39;CMDSTAN_VERSION := &#39;</span><span class="p">)</span>
    <span class="n">end_idx</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">)</span>

    <span class="n">version</span> <span class="o">=</span> <span class="n">contents</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Cannot parse version, expected &quot;&lt;major&gt;.&lt;minor&gt;.&lt;patch&gt;&quot;, &#39;</span>
            <span class="s1">&#39;found: &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span><span class="p">,</span>
            <span class="n">version</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span></div>


<span class="k">def</span> <span class="nf">cmdstan_version_before</span><span class="p">(</span>
    <span class="n">major</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">minor</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that CmdStan version is less than Major.minor version.</span>

<span class="sd">    :param major: Major version number</span>
<span class="sd">    :param minor: Minor version number</span>

<span class="sd">    :return: True if version at or above major.minor, else False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cur_version</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s1">&#39;stan_version_major&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
        <span class="n">cur_version</span> <span class="o">=</span> <span class="n">cmdstan_version</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cur_version</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;stan_version_major&#39;</span><span class="p">]),</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;stan_version_minor&#39;</span><span class="p">]),</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">cur_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Cannot determine whether version is before </span><span class="si">%d</span><span class="s1">.</span><span class="si">%d</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">cur_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">major</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="n">cur_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">major</span> <span class="ow">and</span> <span class="n">cur_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minor</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">cxx_toolchain_path</span><span class="p">(</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">install_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate, then activate C++ toolchain directory path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;Windows&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s1">&#39;Functionality is currently only supported on Windows&#39;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Format version number as a string&#39;</span><span class="p">)</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;CMDSTAN_TOOLCHAIN&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">toolchain_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CMDSTAN_TOOLCHAIN&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolchain_root</span><span class="p">,</span> <span class="s1">&#39;mingw64&#39;</span><span class="p">)):</span>
            <span class="n">compiler_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">toolchain_root</span><span class="p">,</span>
                <span class="s1">&#39;mingw64&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;mingw32&#39;</span><span class="p">,</span>
                <span class="s1">&#39;bin&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">compiler_path</span><span class="p">):</span>
                <span class="n">tool_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolchain_root</span><span class="p">,</span> <span class="s1">&#39;usr&#39;</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tool_path</span><span class="p">):</span>
                    <span class="n">tool_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">compiler_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s1">&#39;Found invalid installion for RTools40 on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">toolchain_root</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">toolchain_root</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">compiler_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;Found invalid installion for RTools40 on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">toolchain_root</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">toolchain_root</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolchain_root</span><span class="p">,</span> <span class="s1">&#39;mingw_64&#39;</span><span class="p">)):</span>
            <span class="n">compiler_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">toolchain_root</span><span class="p">,</span>
                <span class="s1">&#39;mingw_64&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;mingw_32&#39;</span><span class="p">,</span>
                <span class="s1">&#39;bin&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">compiler_path</span><span class="p">):</span>
                <span class="n">tool_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolchain_root</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tool_path</span><span class="p">):</span>
                    <span class="n">tool_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">compiler_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s1">&#39;Found invalid installion for RTools35 on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">toolchain_root</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">toolchain_root</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">compiler_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;Found invalid installion for RTools35 on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">toolchain_root</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">toolchain_root</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rtools40_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RTOOLS40_HOME&#39;</span><span class="p">)</span>
        <span class="n">cmdstan_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">,</span> <span class="n">_DOT_CMDSTAN</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">toolchain_root</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">([</span><span class="n">rtools40_home</span><span class="p">]</span> <span class="k">if</span> <span class="n">rtools40_home</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[])</span>
            <span class="o">+</span> <span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">install_dir</span><span class="p">,</span> <span class="s1">&#39;RTools40&#39;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">install_dir</span><span class="p">,</span> <span class="s1">&#39;RTools35&#39;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">install_dir</span><span class="p">,</span> <span class="s1">&#39;RTools30&#39;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">install_dir</span><span class="p">,</span> <span class="s1">&#39;RTools&#39;</span><span class="p">),</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="n">install_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="p">[]</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="p">[</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmdstan_dir</span><span class="p">,</span> <span class="s1">&#39;RTools40&#39;</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span> <span class="s2">&quot;RTools40&quot;</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmdstan_dir</span><span class="p">,</span> <span class="s1">&#39;RTools35&#39;</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span> <span class="s2">&quot;RTools35&quot;</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmdstan_dir</span><span class="p">,</span> <span class="s1">&#39;RTools&#39;</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span> <span class="s2">&quot;RTools&quot;</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span> <span class="s2">&quot;RBuildTools&quot;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">):</span>
            <span class="n">compiler_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">tool_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">toolchain_root</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">version</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;35&#39;</span><span class="p">,</span> <span class="s1">&#39;3.5&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">):</span>
                    <span class="n">compiler_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">toolchain_root</span><span class="p">,</span>
                        <span class="s1">&#39;mingw64&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;mingw32&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;bin&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">compiler_path</span><span class="p">):</span>
                        <span class="n">tool_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolchain_root</span><span class="p">,</span> <span class="s1">&#39;usr&#39;</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tool_path</span><span class="p">):</span>
                            <span class="n">tool_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                            <span class="n">compiler_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s1">&#39;Found invalid installation for RTools40 on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">toolchain_root</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">toolchain_root</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">compiler_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s1">&#39;Found invalid installation for RTools40 on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">toolchain_root</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">toolchain_root</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">compiler_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">toolchain_root</span><span class="p">,</span>
                        <span class="s1">&#39;mingw_64&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;mingw_32&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;bin&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">compiler_path</span><span class="p">):</span>
                        <span class="n">tool_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolchain_root</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tool_path</span><span class="p">):</span>
                            <span class="n">tool_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                            <span class="n">compiler_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s1">&#39;Found invalid installation for RTools35 on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">toolchain_root</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">toolchain_root</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">compiler_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s1">&#39;Found invalid installation for RTools35 on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">toolchain_root</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">toolchain_root</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">toolchain_root</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">toolchain_root</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;no RTools toolchain installation found, &#39;</span>
            <span class="s1">&#39;run command line script &#39;</span>
            <span class="s1">&#39;&quot;python -m cmdstanpy.install_cxx_toolchain&quot;&#39;</span>
        <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Add C++ toolchain to $PATH: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">toolchain_root</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="nb">list</span><span class="p">(</span>
            <span class="n">OrderedDict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span>
                <span class="p">[</span><span class="n">compiler_path</span><span class="p">,</span> <span class="n">tool_path</span><span class="p">]</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">compiler_path</span><span class="p">,</span> <span class="n">tool_path</span>


<span class="k">def</span> <span class="nf">rewrite_inf_nan</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Replaces NaN and Infinity with string representations&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;NaN&#39;</span>
        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span> <span class="k">if</span> <span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;inf&#39;</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">rewrite_inf_nan</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">serialize_complex</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">complex</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">imag</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unserializable type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="write_stan_json"><a class="viewcode-back" href="../../api.html#cmdstanpy.write_stan_json">[docs]</a><span class="k">def</span> <span class="nf">write_stan_json</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dump a mapping of strings to data to a JSON file.</span>

<span class="sd">    Values can be any numeric type, a boolean (converted to int),</span>
<span class="sd">    or any collection compatible with :func:`numpy.asarray`, e.g a</span>
<span class="sd">    :class:`pandas.Series`.</span>

<span class="sd">    Produces a file compatible with the</span>
<span class="sd">    `Json Format for Cmdstan</span>
<span class="sd">    &lt;https://mc-stan.org/docs/2_27/cmdstan-guide/json.html&gt;`__</span>

<span class="sd">    :param path: File path for the created json. Will be overwritten if</span>
<span class="sd">        already in existence.</span>

<span class="sd">    :param data: A mapping from strings to values. This can be a dictionary</span>
<span class="sd">        or something more exotic like an :class:`xarray.Dataset`. This will be</span>
<span class="sd">        copied before type conversion, not modified</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">handle_nan_inf</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">!=</span> <span class="s1">&#39;numpy&#39;</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">Collection</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Invalid type &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; provided to &quot;</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;write_stan_json for key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">handle_nan_inf</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># handles cases like val == [&#39;hello&#39;]</span>
                <span class="c1"># pylint: disable=raise-missing-from</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid type provided to &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;write_stan_json for key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;as part of collection </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="n">data_out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Collection</span><span class="p">):</span>
            <span class="n">data_out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">data_out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">if</span> <span class="n">handle_nan_inf</span><span class="p">:</span>
            <span class="n">data_out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">rewrite_inf_nan</span><span class="p">(</span><span class="n">data_out</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ujson</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data_out</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data_out</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">serialize_complex</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">rload</span><span class="p">(</span><span class="n">fname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]]:</span>
    <span class="sd">&quot;&quot;&quot;Parse data and parameter variable values from an R dump format file.</span>
<span class="sd">    This parser only supports the subset of R dump data as described</span>
<span class="sd">    in the &quot;Dump Data Format&quot; section of the CmdStan manual, i.e.,</span>
<span class="sd">    scalar, vector, matrix, and array data types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="c1"># Variable data may span multiple lines, parse accordingly</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;&lt;-&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">start_idx</span> <span class="o">=</span> <span class="n">idx</span>
    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;&lt;-&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">next_var</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">next_var</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">var_data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;-&#39;</span><span class="p">)]</span>
        <span class="n">lhs</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># strip optional Jags double quotes</span>
        <span class="n">rhs</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># strip R long int qualifier</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="n">lhs</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_rdump_value</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="n">next_var</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">data_dict</span>


<span class="k">def</span> <span class="nf">parse_rdump_value</span><span class="p">(</span><span class="n">rhs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Process right hand side of Rdump variable assignment statement.</span>
<span class="sd">    Value is either scalar, vector, or multi-dim structure.</span>
<span class="sd">    Use regex to capture structure values, dimensions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;structure\(\s*c\((?P&lt;vals&gt;[^)]*)\)&#39;</span>
        <span class="sa">r</span><span class="s1">&#39;(,\s*\.Dim\s*=\s*c\s*\((?P&lt;dims&gt;[^)]*)\s*\))?\)&#39;</span>
    <span class="p">)</span>
    <span class="n">val</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rhs</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;structure&#39;</span><span class="p">):</span>
            <span class="n">parse</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parse</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">parse</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;vals&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parse</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;vals&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parse</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;dims&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parse</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;dims&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rhs</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;c(&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rhs</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rhs</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span>
        <span class="k">elif</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">rhs</span> <span class="ow">or</span> <span class="s1">&#39;e&#39;</span> <span class="ow">in</span> <span class="n">rhs</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;bad value in Rdump file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rhs</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">return</span> <span class="n">val</span>


<span class="k">def</span> <span class="nf">check_sampler_csv</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">is_fixed_param</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">iter_sampling</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">iter_warmup</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_warmup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">thin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Capture essential config, shape from stan_csv file.&quot;&quot;&quot;</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">scan_sampler_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">is_fixed_param</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">thin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">thin</span> <span class="o">=</span> <span class="n">_CMDSTAN_THIN</span>
    <span class="k">elif</span> <span class="n">thin</span> <span class="o">&gt;</span> <span class="n">_CMDSTAN_THIN</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;thin&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;bad Stan CSV file </span><span class="si">{}</span><span class="s1">, &#39;</span>
                <span class="s1">&#39;config error, expected thin = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">thin</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;thin&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">thin</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;bad Stan CSV file </span><span class="si">{}</span><span class="s1">, &#39;</span>
                <span class="s1">&#39;config error, expected thin = </span><span class="si">{}</span><span class="s1">, found </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">path</span><span class="p">,</span> <span class="n">thin</span><span class="p">,</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;thin&#39;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="n">draws_sampling</span> <span class="o">=</span> <span class="n">iter_sampling</span>
    <span class="k">if</span> <span class="n">draws_sampling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">draws_sampling</span> <span class="o">=</span> <span class="n">_CMDSTAN_SAMPLING</span>
    <span class="n">draws_warmup</span> <span class="o">=</span> <span class="n">iter_warmup</span>
    <span class="k">if</span> <span class="n">draws_warmup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">draws_warmup</span> <span class="o">=</span> <span class="n">_CMDSTAN_WARMUP</span>
    <span class="n">draws_warmup</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">draws_warmup</span> <span class="o">/</span> <span class="n">thin</span><span class="p">))</span>
    <span class="n">draws_sampling</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">draws_sampling</span> <span class="o">/</span> <span class="n">thin</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;draws_sampling&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">draws_sampling</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;bad Stan CSV file </span><span class="si">{}</span><span class="s1">, expected </span><span class="si">{}</span><span class="s1"> draws, found </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">draws_sampling</span><span class="p">,</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;draws_sampling&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">save_warmup</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;save_warmup&#39;</span> <span class="ow">in</span> <span class="n">meta</span> <span class="ow">and</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;save_warmup&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;bad Stan CSV file </span><span class="si">{}</span><span class="s1">, &#39;</span>
                <span class="s1">&#39;config error, expected save_warmup = 1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;draws_warmup&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">draws_warmup</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;bad Stan CSV file </span><span class="si">{}</span><span class="s1">, &#39;</span>
                <span class="s1">&#39;expected </span><span class="si">{}</span><span class="s1"> warmup draws, found </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">path</span><span class="p">,</span> <span class="n">draws_warmup</span><span class="p">,</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;draws_warmup&#39;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">meta</span>


<span class="k">def</span> <span class="nf">scan_sampler_csv</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_fixed_param</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Process sampler stan_csv output file line by line.&quot;&quot;&quot;</span>
    <span class="nb">dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lineno</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="n">scan_config</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="n">scan_column_names</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_fixed_param</span><span class="p">:</span>
                <span class="n">lineno</span> <span class="o">=</span> <span class="n">scan_warmup_iters</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
                <span class="n">lineno</span> <span class="o">=</span> <span class="n">scan_hmc_params</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="n">scan_sampling_iters</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">is_fixed_param</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error in reading csv file: &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">return</span> <span class="nb">dict</span>


<span class="k">def</span> <span class="nf">scan_optimize_csv</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">save_iters</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Process optimizer stan_csv output file line by line.&quot;&quot;&quot;</span>
    <span class="nb">dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lineno</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># scan to find config, header, num saved iters</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="n">scan_config</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="n">scan_column_names</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
        <span class="n">iters</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">iters</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">save_iters</span><span class="p">:</span>
        <span class="n">all_iters</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
            <span class="p">(</span><span class="n">iters</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;column_names&#39;</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span>
        <span class="p">)</span>
    <span class="c1"># rescan to capture estimates</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lineno</span><span class="p">):</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iters</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;cannot parse CSV file </span><span class="si">{}</span><span class="s1">, error at line </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">path</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">+</span> <span class="n">i</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save_iters</span><span class="p">:</span>
                <span class="n">all_iters</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">iters</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mle</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;mle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mle</span>
    <span class="k">if</span> <span class="n">save_iters</span><span class="p">:</span>
        <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;all_iters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_iters</span>
    <span class="k">return</span> <span class="nb">dict</span>


<span class="k">def</span> <span class="nf">scan_generated_quantities_csv</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process standalone generated quantities stan_csv output file line by line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lineno</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="n">scan_config</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="n">scan_column_names</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span>


<span class="k">def</span> <span class="nf">scan_variational_csv</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Process advi stan_csv output file line by line.&quot;&quot;&quot;</span>
    <span class="nb">dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lineno</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="n">scan_config</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="n">scan_column_names</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; #</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="n">lineno</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Stepsize adaptation complete.&#39;</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; #</span><span class="se">\t\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">lineno</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;eta&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;line </span><span class="si">{}</span><span class="s1">: expecting eta, found:</span><span class="se">\n\t</span><span class="s1"> &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">lineno</span><span class="p">,</span> <span class="n">line</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
            <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">eta</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; #</span><span class="se">\t\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">lineno</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">variational_mean</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>
        <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;variational_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">variational_mean</span><span class="p">)</span>
        <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;variational_sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">path</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span>
            <span class="n">skiprows</span><span class="o">=</span><span class="n">lineno</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">float_precision</span><span class="o">=</span><span class="s1">&#39;high&#39;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span>


<span class="k">def</span> <span class="nf">scan_config</span><span class="p">(</span><span class="n">fd</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">lineno</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scan initial stan_csv file comments lines and</span>
<span class="sd">    save non-default configuration information to config_dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cur_pos</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
        <span class="n">lineno</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;(Default)&#39;</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(Default)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; #</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">key_val</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">key_val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;csv&#39;</span><span class="p">):</span>
                <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">key_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
                <span class="n">raw_val</span> <span class="o">=</span> <span class="n">key_val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">val</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw_val</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">raw_val</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">raw_val</span>
                <span class="n">config_dict</span><span class="p">[</span><span class="n">key_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="n">cur_pos</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">cur_pos</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lineno</span>


<span class="k">def</span> <span class="nf">scan_warmup_iters</span><span class="p">(</span>
    <span class="n">fd</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">lineno</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check warmup iterations, if any.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;save_warmup&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lineno</span>
    <span class="n">cur_pos</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">draws_found</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
        <span class="n">lineno</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">draws_found</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">cur_pos</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">cur_pos</span><span class="p">)</span>
    <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;draws_warmup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">draws_found</span>
    <span class="k">return</span> <span class="n">lineno</span>


<span class="k">def</span> <span class="nf">scan_column_names</span><span class="p">(</span>
    <span class="n">fd</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">lineno</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process columns header, add to config_dict as &#39;column_names&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">lineno</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;column_names_raw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
    <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;column_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">munge_varnames</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">lineno</span>


<span class="k">def</span> <span class="nf">munge_varnames</span><span class="p">(</span><span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Change formatting for indices of container var elements</span>
<span class="sd">    from use of dot separator to array-like notation, e.g.,</span>
<span class="sd">    rewrite label ``y_forecast.2.4`` to ``y_forecast[2,4]``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;missing argument &quot;names&quot;&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">head</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">head</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rest</span><span class="p">),</span> <span class="s1">&#39;]&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">parse_method_vars</span><span class="p">(</span><span class="n">names</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses out names ending in `__` from list of CSV file column names.</span>
<span class="sd">    Return a dict mapping sampler variable name to Stan CSV file column, using</span>
<span class="sd">    zero-based column indexing.</span>
<span class="sd">    Currently, (Stan 2.X) all CmdStan inference method vars are scalar,</span>
<span class="sd">    the map entries are tuples of int to allow for structured variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;missing argument &quot;names&quot;&#39;</span><span class="p">)</span>
    <span class="c1"># note: method vars are currently all scalar so not checking for structure</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="p">(</span><span class="n">k</span><span class="p">,)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)}</span>


<span class="k">def</span> <span class="nf">parse_stan_vars</span><span class="p">(</span>
    <span class="n">names</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
    <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseType</span><span class="p">]</span>
<span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses out Stan variable names (i.e., names not ending in `__`)</span>
<span class="sd">    from list of CSV file column names.</span>
<span class="sd">    Returns three dicts which map variable names to base type, dimensions and</span>
<span class="sd">    CSV file columns, respectively, using zero-based column indexing.</span>
<span class="sd">    Note: assumes: (a) munged varnames and (b) container vars are non-ragged</span>
<span class="sd">    and dense; no checks on size, indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;missing argument &quot;names&quot;&#39;</span><span class="p">)</span>
    <span class="n">dims_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cols_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">types_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dims</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;real]&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;imag]&#39;</span><span class="p">):</span>
            <span class="n">basetype</span> <span class="o">=</span> <span class="n">BaseType</span><span class="o">.</span><span class="n">COMPLEX</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basetype</span> <span class="o">=</span> <span class="n">BaseType</span><span class="o">.</span><span class="n">PRIM</span>
        <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">var</span><span class="p">,</span> <span class="o">*</span><span class="n">dims</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">):</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dims_map</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
            <span class="n">cols_map</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
            <span class="n">types_map</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">basetype</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">names</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">var</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;imag&#39;</span><span class="p">:</span>
                <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">]</span>
            <span class="n">dims_map</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
            <span class="n">cols_map</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
            <span class="n">types_map</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">basetype</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">dims_map</span><span class="p">,</span> <span class="n">cols_map</span><span class="p">,</span> <span class="n">types_map</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">scan_hmc_params</span><span class="p">(</span>
    <span class="n">fd</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">lineno</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scan step size, metric from  stan_csv file comment lines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">lineno</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;# Adaptation terminated&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;line </span><span class="si">{}</span><span class="s1">: expecting metric, found:</span><span class="se">\n\t</span><span class="s1"> &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lineno</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">lineno</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">label</span><span class="p">,</span> <span class="n">step_size</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;# Step size&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;line </span><span class="si">{}</span><span class="s1">: expecting step size, &#39;</span>
            <span class="s1">&#39;found:</span><span class="se">\n\t</span><span class="s1"> &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lineno</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">step_size</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;line </span><span class="si">{}</span><span class="s1">: invalid step size: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lineno</span><span class="p">,</span> <span class="n">step_size</span><span class="p">)</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;unit_e&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lineno</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">lineno</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="p">(</span>
            <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;diag_e&#39;</span>
            <span class="ow">and</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;# Diagonal elements of inverse mass matrix:&#39;</span>
        <span class="p">)</span>
        <span class="ow">or</span> <span class="p">(</span>
            <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;dense_e&#39;</span> <span class="ow">and</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;# Elements of inverse mass matrix:&#39;</span>
        <span class="p">)</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;line </span><span class="si">{}</span><span class="s1">: invalid or missing mass matrix &#39;</span>
            <span class="s1">&#39;specification&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lineno</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; #</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">lineno</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">num_unconstrained_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;diag_e&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lineno</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_unconstrained_params</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; #</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">lineno</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="n">num_unconstrained_params</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;line </span><span class="si">{}</span><span class="s1">: invalid or missing mass matrix &#39;</span>
                    <span class="s1">&#39;specification&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lineno</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">lineno</span>


<span class="k">def</span> <span class="nf">scan_sampling_iters</span><span class="p">(</span>
    <span class="n">fd</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">lineno</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">is_fixed_param</span><span class="p">:</span> <span class="nb">bool</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse sampling iteration, save number of iterations to config_dict.</span>
<span class="sd">    Also save number of divergences, max_treedepth hits</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">draws_found</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;column_names&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_fixed_param</span><span class="p">:</span>
        <span class="n">idx_divergent</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;column_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;divergent__&#39;</span><span class="p">)</span>
        <span class="n">idx_treedepth</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;column_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;treedepth__&#39;</span><span class="p">)</span>
        <span class="n">max_treedepth</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;max_depth&#39;</span><span class="p">]</span>
        <span class="n">ct_divergences</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ct_max_treedepth</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">cur_pos</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
        <span class="n">lineno</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">draws_found</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">num_cols</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;line </span><span class="si">{}</span><span class="s1">: bad draw, expecting </span><span class="si">{}</span><span class="s1"> items, found </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">lineno</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="s1">&#39;This error could be caused by running out of disk space.</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;Try clearing up TEMP or setting output_dir to a path&#39;</span>
                <span class="s1">&#39; on another drive.&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">cur_pos</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_fixed_param</span><span class="p">:</span>
            <span class="n">ct_divergences</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">idx_divergent</span><span class="p">])</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">idx_treedepth</span><span class="p">])</span> <span class="o">==</span> <span class="n">max_treedepth</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
                <span class="n">ct_max_treedepth</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">cur_pos</span><span class="p">)</span>
    <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;draws_sampling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">draws_found</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_fixed_param</span><span class="p">:</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;ct_divergences&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_divergences</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;ct_max_treedepth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_max_treedepth</span>
    <span class="k">return</span> <span class="n">lineno</span>


<span class="k">def</span> <span class="nf">read_metric</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read metric file in JSON or Rdump format.</span>
<span class="sd">    Return dimensions of entry &quot;inv_metric&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">metric_dict</span> <span class="o">=</span> <span class="n">ujson</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;inv_metric&#39;</span> <span class="ow">in</span> <span class="n">metric_dict</span><span class="p">:</span>
            <span class="n">dims_np</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;inv_metric&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">dims_np</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;metric file </span><span class="si">{}</span><span class="s1">, bad or missing&#39;</span>
                <span class="s1">&#39; entry &quot;inv_metric&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">read_rdump_metric</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;metric file </span><span class="si">{}</span><span class="s1">, bad or missing&#39;</span>
                <span class="s1">&#39; entry &quot;inv_metric&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">dims</span>


<span class="k">def</span> <span class="nf">read_rdump_metric</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find dimensions of variable named &#39;inv_metric&#39; in Rdump data file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metric_dict</span> <span class="o">=</span> <span class="n">rload</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">metric_dict</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="s1">&#39;inv_metric&#39;</span> <span class="ow">in</span> <span class="n">metric_dict</span>
        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;inv_metric&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;metric file </span><span class="si">{}</span><span class="s1">, bad or missing entry &quot;inv_metric&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_dict</span><span class="p">[</span><span class="s1">&#39;inv_metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">do_command</span><span class="p">(</span>
    <span class="n">cmd</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">fd_out</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TextIO</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
    <span class="n">pbar</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run command as subprocess, polls process output pipes and</span>
<span class="sd">    either streams outputs to supplied output stream or sends</span>
<span class="sd">    each line (stripped) to the supplied progress bar callback hook.</span>

<span class="sd">    Raises ``RuntimeError`` on non-zero return code or execption ``OSError``.</span>

<span class="sd">    :param cmd: command and args.</span>
<span class="sd">    :param cwd: directory in which to run command, if unspecified,</span>
<span class="sd">        run command in the current working directory.</span>
<span class="sd">    :param fd_out: when supplied, streams to this output stream,</span>
<span class="sd">        else writes to sys.stdout.</span>
<span class="sd">    :param pbar: optional callback hook to tqdm, which takes</span>
<span class="sd">       single ``str`` arguent, see:</span>
<span class="sd">       https://github.com/tqdm/tqdm#hooks-and-callbacks.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;cmd: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">cwd: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">cwd</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># NB: Using this rather than cwd arg to Popen due to windows behavior</span>
        <span class="k">with</span> <span class="n">pushd</span><span class="p">(</span><span class="n">cwd</span> <span class="k">if</span> <span class="n">cwd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="c1"># TODO: replace with subprocess.run in later Python versions?</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span>
                <span class="n">bufsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>  <span class="c1"># avoid buffer overflow</span>
                <span class="n">env</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span>
                <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">while</span> <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">fd_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">fd_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="n">stdout</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stdout</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fd_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">fd_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># throw RuntimeError + msg</span>
                <span class="n">serror</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">serror</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">strerror</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ArithmeticError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Command </span><span class="si">{}</span><span class="se">\n\t</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="p">,</span> <span class="n">returncode_msg</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">),</span> <span class="n">serror</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Command: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">failed with error </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>


<span class="k">def</span> <span class="nf">returncode_msg</span><span class="p">(</span><span class="n">retcode</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;interpret retcode&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">retcode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">retcode</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;terminated by signal </span><span class="si">{</span><span class="n">sig</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">if</span> <span class="n">retcode</span> <span class="o">&lt;=</span> <span class="mi">125</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;error during processing&#39;</span>
    <span class="k">if</span> <span class="n">retcode</span> <span class="o">==</span> <span class="mi">126</span><span class="p">:</span>  <span class="c1"># shouldn&#39;t happen</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">retcode</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;program not found&#39;</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">retcode</span> <span class="o">-</span> <span class="mi">128</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;terminated by signal </span><span class="si">{</span><span class="n">sig</span><span class="si">}</span><span class="s1">&#39;</span>


<span class="k">def</span> <span class="nf">windows_short_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the short path name of a given long path.</span>
<span class="sd">    http://stackoverflow.com/a/23598461/200291</span>

<span class="sd">    On non-Windows platforms, returns the path</span>

<span class="sd">    If (base)path does not exist, function raises RuntimeError</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;Windows&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span>
    <span class="p">):</span>
        <span class="n">base_path</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_path</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">path</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s1">&#39;Windows short path function needs a valid directory. &#39;</span>
            <span class="s1">&#39;Base directory does not exist: &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="kn">import</span> <span class="nn">ctypes</span>
    <span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">wintypes</span>

    <span class="c1"># pylint: disable=invalid-name</span>
    <span class="n">_GetShortPathNameW</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">GetShortPathNameW</span>  <span class="c1"># type: ignore</span>
    <span class="p">)</span>

    <span class="n">_GetShortPathNameW</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">wintypes</span><span class="o">.</span><span class="n">LPCWSTR</span><span class="p">,</span>
        <span class="n">wintypes</span><span class="o">.</span><span class="n">LPWSTR</span><span class="p">,</span>
        <span class="n">wintypes</span><span class="o">.</span><span class="n">DWORD</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">_GetShortPathNameW</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">wintypes</span><span class="o">.</span><span class="n">DWORD</span>

    <span class="n">output_buf_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">output_buf</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">create_unicode_buffer</span><span class="p">(</span><span class="n">output_buf_size</span><span class="p">)</span>
        <span class="n">needed</span> <span class="o">=</span> <span class="n">_GetShortPathNameW</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">output_buf</span><span class="p">,</span> <span class="n">output_buf_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_buf_size</span> <span class="o">&gt;=</span> <span class="n">needed</span><span class="p">:</span>
            <span class="n">short_base_path</span> <span class="o">=</span> <span class="n">output_buf</span><span class="o">.</span><span class="n">value</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_buf_size</span> <span class="o">=</span> <span class="n">needed</span>

    <span class="n">short_path</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">short_base_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_name</span>
        <span class="k">else</span> <span class="n">short_base_path</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">short_path</span>


<span class="k">def</span> <span class="nf">create_named_text_file</span><span class="p">(</span>
    <span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a named unique file, return filename.</span>
<span class="sd">    Flag &#39;name_only&#39; will create then delete the tmp file;</span>
<span class="sd">    this lets us create filename args for commands which</span>
<span class="sd">    disallow overwriting existing files (e.g., &#39;stansummary&#39;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span>
        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="nb">dir</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="n">name_only</span>
    <span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">name</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">path</span>


<div class="viewcode-block" id="show_versions"><a class="viewcode-back" href="../../api.html#cmdstanpy.show_versions">[docs]</a><span class="k">def</span> <span class="nf">show_versions</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Prints out system and dependency information for debugging&quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">importlib</span>
    <span class="kn">import</span> <span class="nn">locale</span>
    <span class="kn">import</span> <span class="nn">struct</span>

    <span class="n">deps_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="p">(</span><span class="n">sysname</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">release</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">processor</span><span class="p">)</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">uname</span><span class="p">()</span>
        <span class="n">deps_info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;python-bits&quot;</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;OS&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sysname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;OS-release&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">release</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;machine&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">machine</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;processor&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">processor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;byteorder&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;LC_ALL&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LC_ALL&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;LANG&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LANG&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;LOCALE&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">locale</span><span class="o">.</span><span class="n">getlocale</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="c1"># pylint: disable=broad-except</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">deps_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;cmdstan_folder&#39;</span><span class="p">,</span> <span class="n">cmdstan_path</span><span class="p">()))</span>
        <span class="n">deps_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;cmdstan&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cmdstan_version</span><span class="p">())))</span>
    <span class="c1"># pylint: disable=broad-except</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">deps_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;cmdstan&#39;</span><span class="p">,</span> <span class="s1">&#39;NOT FOUND&#39;</span><span class="p">))</span>

    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cmdstanpy&#39;</span><span class="p">,</span> <span class="s1">&#39;pandas&#39;</span><span class="p">,</span> <span class="s1">&#39;xarray&#39;</span><span class="p">,</span> <span class="s1">&#39;tdqm&#39;</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;ujson&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="c1"># pylint: disable=broad-except</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">deps_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">module</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ver</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">__version__</span>  <span class="c1"># type: ignore</span>
                <span class="n">deps_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">module</span><span class="p">,</span> <span class="n">ver</span><span class="p">))</span>
            <span class="c1"># pylint: disable=broad-except</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">deps_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;installed&quot;</span><span class="p">))</span>

    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;INSTALLED VERSIONS</span><span class="se">\n</span><span class="s1">---------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">deps_info</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">info</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot; &quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="install_cmdstan"><a class="viewcode-back" href="../../api.html#cmdstanpy.install_cmdstan">[docs]</a><span class="k">def</span> <span class="nf">install_cmdstan</span><span class="p">(</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="nb">dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">compiler</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">interactive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download and install a CmdStan release from GitHub. Downloads the release</span>
<span class="sd">    tar.gz file to temporary storage.  Retries GitHub requests in order</span>
<span class="sd">    to allow for transient network outages. Builds CmdStan executables</span>
<span class="sd">    and tests the compiler by building example model ``bernoulli.stan``.</span>

<span class="sd">    :param version: CmdStan version string, e.g. &quot;2.29.2&quot;.</span>
<span class="sd">        Defaults to latest CmdStan release.</span>

<span class="sd">    :param dir: Path to install directory.  Defaults to hidden directory</span>
<span class="sd">        ``$HOME/.cmdstan``.</span>
<span class="sd">        If no directory is specified and the above directory does not</span>
<span class="sd">        exist, directory ``$HOME/.cmdstan`` will be created and populated.</span>

<span class="sd">    :param overwrite:  Boolean value; when ``True``, will overwrite and</span>
<span class="sd">        rebuild an existing CmdStan installation.  Default is ``False``.</span>

<span class="sd">    :param compiler: Boolean value; when ``True`` on WINDOWS ONLY, use the</span>
<span class="sd">        C++ compiler from the ``install_cxx_toolchain`` command or install</span>
<span class="sd">        one if none is found.</span>

<span class="sd">    :param progress: Boolean value; when ``True``, show a progress bar for</span>
<span class="sd">        downloading and unpacking CmdStan.  Default is ``False``.</span>

<span class="sd">    :param verbose: Boolean value; when ``True``, show console output from all</span>
<span class="sd">        intallation steps, i.e., download, build, and test CmdStan release.</span>
<span class="sd">        Default is ``False``.</span>
<span class="sd">    :param cores: Integer, number of cores to use in the ``make`` command.</span>
<span class="sd">        Default is 1 core.</span>

<span class="sd">    :param interactive: Boolean value; if true, ignore all other arguments</span>
<span class="sd">        to this function and run in an interactive mode, prompting the user</span>
<span class="sd">        to provide the other information manually through the standard input.</span>

<span class="sd">        This flag should only be used in interactive environments,</span>
<span class="sd">        e.g. on the command line.</span>

<span class="sd">    :return: Boolean value; ``True`` for success.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.install_cmdstan</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">InstallationSettings</span><span class="p">,</span>
            <span class="n">InteractiveSettings</span><span class="p">,</span>
            <span class="n">run_install</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">args</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">InstallationSettings</span><span class="p">,</span> <span class="n">InteractiveSettings</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">version</span><span class="p">,</span>
                    <span class="nb">dir</span><span class="p">,</span>
                    <span class="n">overwrite</span><span class="p">,</span>
                    <span class="n">compiler</span><span class="p">,</span>
                    <span class="n">progress</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="p">,</span>
                    <span class="n">cores</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Interactive installation requested but other arguments&quot;</span>
                    <span class="s2">&quot; were used.</span><span class="se">\n\t</span><span class="s2">These values will be ignored!&quot;</span>
                <span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">InteractiveSettings</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">InstallationSettings</span><span class="p">(</span>
                <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">compiler</span><span class="o">=</span><span class="n">compiler</span><span class="p">,</span>
                <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                <span class="nb">dir</span><span class="o">=</span><span class="nb">dir</span><span class="p">,</span>
                <span class="n">cores</span><span class="o">=</span><span class="n">cores</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">run_install</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="c1"># pylint: disable=broad-except</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;CmdStan installation failed.</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">set_cmdstan_path</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<span class="nd">@progbar</span><span class="o">.</span><span class="n">wrap_callback</span>
<span class="k">def</span> <span class="nf">wrap_url_progress_hook</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Sets up tqdm callback for url downloads.&quot;&quot;&quot;</span>
    <span class="n">pbar</span><span class="p">:</span> <span class="n">tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">,</span>
        <span class="n">unit_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">unit_divisor</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
        <span class="n">colour</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
        <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">download_progress_hook</span><span class="p">(</span>
        <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">block_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">total_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pbar</span><span class="o">.</span><span class="n">total</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">total_size</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">downloaded_size</span> <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">block_size</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">downloaded_size</span> <span class="o">-</span> <span class="n">pbar</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pbar</span><span class="o">.</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">total_size</span><span class="p">:</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">download_progress_hook</span>


<span class="k">def</span> <span class="nf">flatten_chains</span><span class="p">(</span><span class="n">draws_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flatten a 3D array of draws X chains X variable into 2D array</span>
<span class="sd">    where all chains are concatenated into a single column.</span>

<span class="sd">    :param draws_array: 3D array of draws</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">draws_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Expecting 3D array, found array with </span><span class="si">{}</span><span class="s1"> dims&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">draws_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">num_rows</span> <span class="o">=</span> <span class="n">draws_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">draws_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">num_cols</span> <span class="o">=</span> <span class="n">draws_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">draws_array</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>


<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">pushd</span><span class="p">(</span><span class="n">new_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Acts like pushd/popd.&quot;&quot;&quot;</span>
    <span class="n">previous_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">new_dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">previous_dir</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">report_signal</span><span class="p">(</span><span class="n">sig</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Provide info for processes terminated by a system signal.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;terminated by signal: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sig</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">MaybeDictToFilePath</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Context manager for json files.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">objs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">],</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unlink</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># pylint: disable=isinstance-second-argument-not-valid-type</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                <span class="n">data_file</span> <span class="o">=</span> <span class="n">create_named_text_file</span><span class="p">(</span>
                    <span class="nb">dir</span><span class="o">=</span><span class="n">_TMPDIR</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.json&#39;</span>
                <span class="p">)</span>
                <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;input tempfile: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">data_file</span><span class="p">)</span>
                <span class="n">write_stan_json</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_unlink</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File doesn&#39;t exist </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">err_msgs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">missing_obj_items</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">obj_item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">err_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span>
                                <span class="s1">&#39;List element </span><span class="si">{}</span><span class="s1"> must be a filename string,&#39;</span>
                                <span class="s1">&#39; found </span><span class="si">{}</span><span class="s1">&#39;</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">obj_item</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">obj_item</span><span class="p">):</span>
                        <span class="n">missing_obj_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s2">&quot;File doesn&#39;t exist: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj_item</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">err_msgs</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">err_msgs</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">missing_obj_items</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_obj_items</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="k">elif</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data must be string or dict&#39;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paths</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="k">for</span> <span class="n">can_unlink</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unlink</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paths</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">can_unlink</span> <span class="ow">and</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
                    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">SanitizedOrTmpFilePath</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Context manager for tmpfiles, handles spaces in filepath.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span><span class="p">:</span>
            <span class="n">base_path</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">short_base_path</span> <span class="o">=</span> <span class="n">windows_short_path</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">short_base_path</span><span class="p">):</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">short_base_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">tmpdir</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s1">&#39;Unable to generate temporary path without spaces! </span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="o">+</span> <span class="s1">&#39;Please move your stan file to location without spaces.&#39;</span>
                <span class="p">)</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.stan&#39;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">tmpdir</span><span class="p">)</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span> <span class="o">=</span> <span class="n">tmpdir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">file_path</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, Stan Development Team.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>