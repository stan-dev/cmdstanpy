
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cmdstanpy.stanfit &#8212; CmdStanPy 1.0.0rc3 documentation</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/project-template.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<link rel="stylesheet" href="_static/basic.css" type="text/css" />

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
<nav id="navbar-main" class="navbar navbar-dark navbar-expand-lg fixed-top bd-navbar"
    style="background-color: #222222;"><div class="container-xl">

  <div id="navbar-start">
    
    <!-- This will display the version of the docs -->
<a class='navbar-brand' href='index.html'>CmdStanPy 1.0.0rc3</a>
    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../overview.html">
  Overview
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../hello_world.html">
  “Hello, World”
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../workflow.html">
  CmdStanPy Workflow
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../examples.html">
  CmdStanPy Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api.html">
  API Reference
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/mcmc_stan" rel="noopener" target="_blank" title="Twitter">
            <span><i class="fab fa-twitter"></i></span>
            <label class="sr-only">Twitter</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/stan-dev/cmdstanpy" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://discourse.mc-stan.org/" rel="noopener" target="_blank" title="Forums">
            <span><i class="fas fa-users"></i></span>
            <label class="sr-only">Forums</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
</nav>


    <div class="container-xl">
      <div class="row">
          
            
            <div class="col-12 col-md-1 col-xl-2 bd-sidebar no-sidebar"></div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-11 col-xl-8 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for cmdstanpy.stanfit</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Container objects for results of CmdStan run(s).&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Hashable</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">MutableMapping</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

    <span class="n">XARRAY_INSTALLED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">XARRAY_INSTALLED</span> <span class="o">=</span> <span class="kc">False</span>

<span class="kn">from</span> <span class="nn">cmdstanpy</span> <span class="kn">import</span> <span class="n">_CMDSTAN_SAMPLING</span><span class="p">,</span> <span class="n">_CMDSTAN_THIN</span><span class="p">,</span> <span class="n">_CMDSTAN_WARMUP</span><span class="p">,</span> <span class="n">_TMPDIR</span>
<span class="kn">from</span> <span class="nn">cmdstanpy.cmdstan_args</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CmdStanArgs</span><span class="p">,</span>
    <span class="n">Method</span><span class="p">,</span>
    <span class="n">OptimizeArgs</span><span class="p">,</span>
    <span class="n">SamplerArgs</span><span class="p">,</span>
    <span class="n">VariationalArgs</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cmdstanpy.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">EXTENSION</span><span class="p">,</span>
    <span class="n">check_sampler_csv</span><span class="p">,</span>
    <span class="n">cmdstan_path</span><span class="p">,</span>
    <span class="n">cmdstan_version_before</span><span class="p">,</span>
    <span class="n">create_named_text_file</span><span class="p">,</span>
    <span class="n">do_command</span><span class="p">,</span>
    <span class="n">flatten_chains</span><span class="p">,</span>
    <span class="n">get_logger</span><span class="p">,</span>
    <span class="n">parse_method_vars</span><span class="p">,</span>
    <span class="n">parse_stan_vars</span><span class="p">,</span>
    <span class="n">scan_config</span><span class="p">,</span>
    <span class="n">scan_generated_quantities_csv</span><span class="p">,</span>
    <span class="n">scan_optimize_csv</span><span class="p">,</span>
    <span class="n">scan_variational_csv</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="RunSet"><a class="viewcode-back" href="../../internal_api.html#cmdstanpy.RunSet">[docs]</a><span class="k">class</span> <span class="nc">RunSet</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encapsulates the configuration and results of a call to any CmdStan</span>
<span class="sd">    inference method. Records the method return code and locations of</span>
<span class="sd">    all console, error, and output files.</span>

<span class="sd">    RunSet objects are instantiated by the CmdStanModel class inference methods</span>
<span class="sd">    which validate all inputs, therefore &quot;__init__&quot; method skips input checks.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">CmdStanArgs</span><span class="p">,</span>
        <span class="n">chains</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">chain_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">time_fmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S&quot;</span><span class="p">,</span>
        <span class="n">one_process_per_chain</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize object (no input arg checks).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chains</span> <span class="o">=</span> <span class="n">chains</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_one_process_per_chain</span> <span class="o">=</span> <span class="n">one_process_per_chain</span>
        <span class="k">if</span> <span class="n">one_process_per_chain</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_procs</span> <span class="o">=</span> <span class="n">chains</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_procs</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_retcodes</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_procs</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">chain_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chain_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">chains</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chain_ids</span> <span class="o">=</span> <span class="n">chain_ids</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span> <span class="o">=</span> <span class="n">_TMPDIR</span>

        <span class="c1"># output files prefix: ``&lt;model_name&gt;-&lt;YYYYMMDDHHMM&gt;_&lt;chain_id&gt;``</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_outfile</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">time_fmt</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="c1"># per-process console messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stdout_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_procs</span>
        <span class="k">if</span> <span class="n">one_process_per_chain</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">chains</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stdout_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(</span><span class="s2">&quot;-stdout.txt&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stdout_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(</span><span class="s2">&quot;-stdout.txt&quot;</span><span class="p">)</span>

        <span class="c1"># per-chain output files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_csv_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">chains</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostic_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">chains</span>  <span class="c1"># optional</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_profile_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">chains</span>  <span class="c1"># optional</span>

        <span class="k">if</span> <span class="n">chains</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_csv_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">save_latent_dynamics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostic_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(</span>
                    <span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="s2">&quot;-diagnostic&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">save_profile</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_profile_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(</span>
                    <span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="s2">&quot;-profile&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">chains</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_csv_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">chain_ids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">save_latent_dynamics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostic_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(</span>
                        <span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="s2">&quot;-diagnostic&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">chain_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">save_profile</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_profile_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(</span>
                        <span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="s2">&quot;-profile&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">chain_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="nb">repr</span> <span class="o">=</span> <span class="s1">&#39;RunSet: chains=</span><span class="si">{}</span><span class="s1">, chain_ids=</span><span class="si">{}</span><span class="s1">, num_processes=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chains</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chain_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_procs</span>
        <span class="p">)</span>
        <span class="nb">repr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1"> cmd (chain 1):</span><span class="se">\n\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="nb">repr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1"> retcodes=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retcodes</span><span class="p">)</span>
        <span class="nb">repr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">repr</span><span class="si">}</span><span class="se">\n</span><span class="s1"> per-chain output files (showing chain 1 only):&#39;</span>
        <span class="nb">repr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1"> csv_file:</span><span class="se">\n\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csv_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">save_latent_dynamics</span><span class="p">:</span>
            <span class="nb">repr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1"> diagnostics_file:</span><span class="se">\n\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">repr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostic_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">save_profile</span><span class="p">:</span>
            <span class="nb">repr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1"> profile_file:</span><span class="se">\n\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">repr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="nb">repr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1"> console_msgs (if any):</span><span class="se">\n\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">repr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stdout_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">repr</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Stan model name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">model_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Method</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;CmdStan method used to generate this fit.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">method</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_procs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Number of processes run.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_procs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">one_process_per_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When True, for each chain, call CmdStan in its own subprocess.</span>
<span class="sd">        When False, use CmdStan&#39;s `num_chains` arg to run parallel chains.</span>
<span class="sd">        Always True if CmdStan &lt; 2.28.</span>
<span class="sd">        For CmdStan 2.28 and up, `sample` method determines value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_one_process_per_chain</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chains</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Number of chains.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chains</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chain_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Chain ids.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chain_ids</span>

<div class="viewcode-block" id="RunSet.cmd"><a class="viewcode-back" href="../../internal_api.html#cmdstanpy.RunSet.cmd">[docs]</a>    <span class="k">def</span> <span class="nf">cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assemble CmdStan invocation.</span>
<span class="sd">        When running parallel chains from single process (2.28 and up),</span>
<span class="sd">        specify CmdStan arg `num_chains` and leave chain idx off CSV files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_one_process_per_chain</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">compose_command</span><span class="p">(</span>
                <span class="n">idx</span><span class="p">,</span>
                <span class="n">csv_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_files</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="n">diagnostic_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostic_files</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">save_latent_dynamics</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">profile_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_files</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">save_profile</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">compose_command</span><span class="p">(</span>
                <span class="n">idx</span><span class="p">,</span>
                <span class="n">csv_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">),</span>
                <span class="n">diagnostic_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="s2">&quot;-diagnostic&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">save_latent_dynamics</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">profile_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="s2">&quot;-profile&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">save_profile</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">num_chains</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chains</span><span class="p">,</span>
            <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">csv_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;List of paths to CmdStan output files.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csv_files</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stdout_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of paths to transcript of CmdStan messages sent to the console.</span>
<span class="sd">        Transcripts include config information, progress, and error messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stdout_files</span>

    <span class="k">def</span> <span class="nf">_check_retcodes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns ``True`` when all chains have retcode 0.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retcodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">diagnostic_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;List of paths to CmdStan hamiltonian diagnostic files.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostic_files</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">profile_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;List of paths to CmdStan profiler files.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_files</span>

    <span class="c1"># pylint: disable=invalid-name</span>
    <span class="k">def</span> <span class="nf">file_path</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">extra</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="nb">id</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_outfile</span><span class="si">}{</span><span class="n">extra</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">file</span>

    <span class="k">def</span> <span class="nf">_retcode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get retcode for process[idx].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retcodes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_set_retcode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set retcode at process[idx] to val.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_retcodes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

<div class="viewcode-block" id="RunSet.get_err_msgs"><a class="viewcode-back" href="../../internal_api.html#cmdstanpy.RunSet.get_err_msgs">[docs]</a>    <span class="k">def</span> <span class="nf">get_err_msgs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Checks console messages for each CmdStan run.&quot;&quot;&quot;</span>
        <span class="n">msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_procs</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stdout_files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stdout_files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">st_size</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="p">:</span>
                    <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;console log output:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stdout_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                        <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stdout_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                        <span class="n">contents</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="c1"># pattern matches initial &quot;Exception&quot; or &quot;Error&quot; msg</span>
                        <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^E[rx].*$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
                        <span class="n">errors</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">contents</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msgs</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunSet.save_csvfiles"><a class="viewcode-back" href="../../internal_api.html#cmdstanpy.RunSet.save_csvfiles">[docs]</a>    <span class="k">def</span> <span class="nf">save_csvfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Moves CSV files to specified directory.</span>

<span class="sd">        :param dir: directory path</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        cmdstanpy.from_csv</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">test_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">()))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">test_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">test_path</span><span class="p">)</span>  <span class="c1"># cleanup</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="ne">PermissionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Cannot save to path: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">dir</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_csv_files</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Cannot access CSV file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_csv_files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="p">)</span>

            <span class="n">to_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_csv_files</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">to_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;File exists, not overwriting: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to_path</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s1">&#39;saving tmpfile: &quot;</span><span class="si">%s</span><span class="s1">&quot; as: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csv_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">to_path</span>
                <span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_csv_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">to_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_csv_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_path</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="ne">PermissionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Cannot save to file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to_path</span><span class="p">)</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span></div></div>


<div class="viewcode-block" id="InferenceMetadata"><a class="viewcode-back" href="../../internal_api.html#cmdstanpy.InferenceMetadata">[docs]</a><span class="k">class</span> <span class="nc">InferenceMetadata</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CmdStan configuration and contents of output file parsed out of</span>
<span class="sd">    the Stan CSV file header comments and column headers.</span>
<span class="sd">    Assumes valid CSV files.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize object from CSV headers&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cmdstan_config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_method_vars_cols</span> <span class="o">=</span> <span class="n">parse_method_vars</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;column_names&#39;</span><span class="p">])</span>
        <span class="n">stan_vars_dims</span><span class="p">,</span> <span class="n">stan_vars_cols</span> <span class="o">=</span> <span class="n">parse_stan_vars</span><span class="p">(</span>
            <span class="n">names</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;column_names&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stan_vars_dims</span> <span class="o">=</span> <span class="n">stan_vars_dims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stan_vars_cols</span> <span class="o">=</span> <span class="n">stan_vars_cols</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Metadata:</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmdstan_config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cmdstan_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary containing a set of name, value pairs</span>
<span class="sd">        parsed out of the Stan CSV file header.  These include the</span>
<span class="sd">        command configuration and the CSV file header row information.</span>
<span class="sd">        Uses deepcopy for immutability.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmdstan_config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">method_vars_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a map from a Stan inference method variable to</span>
<span class="sd">        a tuple of column indices in inference engine&#39;s output array.</span>
<span class="sd">        Method variable names always end in `__`, e.g. `lp__`.</span>
<span class="sd">        Uses deepcopy for immutability.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_method_vars_cols</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stan_vars_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a map from a Stan program variable name to a</span>
<span class="sd">        tuple of the column indices in the vector or matrix of</span>
<span class="sd">        estimates produced by a CmdStan inference method.</span>
<span class="sd">        Uses deepcopy for immutability.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stan_vars_cols</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stan_vars_dims</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns map from Stan program variable names to variable dimensions.</span>
<span class="sd">        Scalar types are mapped to the empty tuple, e.g.,</span>
<span class="sd">        program variable ``int foo`` has dimension ``()`` and</span>
<span class="sd">        program variable ``vector[10] bar`` has single dimension ``(10)``.</span>
<span class="sd">        Uses deepcopy for immutability.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stan_vars_dims</span><span class="p">)</span></div>


<div class="viewcode-block" id="CmdStanMCMC"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanMCMC">[docs]</a><span class="k">class</span> <span class="nc">CmdStanMCMC</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for outputs from CmdStan sampler run.</span>
<span class="sd">    Provides methods to summarize and diagnose the model fit</span>
<span class="sd">    and accessor methods to access the entire sample or</span>
<span class="sd">    individual items. Created by :meth:`CmdStanModel.sample`</span>

<span class="sd">    The sample is lazily instantiated on first access of either</span>
<span class="sd">    the resulting sample or the HMC tuning parameters, i.e., the</span>
<span class="sd">    step size and metric.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># pylint: disable=too-many-public-methods</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">runset</span><span class="p">:</span> <span class="n">RunSet</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">runset</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="n">SAMPLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Wrong runset method, expecting sample runset, &#39;</span>
                <span class="s1">&#39;found method </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">runset</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runset</span> <span class="o">=</span> <span class="n">runset</span>

        <span class="c1"># info from runset to be exposed</span>
        <span class="n">sampler_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">method_args</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">sampler_args</span><span class="p">,</span> <span class="n">SamplerArgs</span>
        <span class="p">)</span>  <span class="c1"># make the typechecker happy</span>
        <span class="n">iter_sampling</span> <span class="o">=</span> <span class="n">sampler_args</span><span class="o">.</span><span class="n">iter_sampling</span>
        <span class="k">if</span> <span class="n">iter_sampling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iter_sampling</span> <span class="o">=</span> <span class="n">_CMDSTAN_SAMPLING</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iter_sampling</span> <span class="o">=</span> <span class="n">iter_sampling</span>
        <span class="n">iter_warmup</span> <span class="o">=</span> <span class="n">sampler_args</span><span class="o">.</span><span class="n">iter_warmup</span>
        <span class="k">if</span> <span class="n">iter_warmup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iter_warmup</span> <span class="o">=</span> <span class="n">_CMDSTAN_WARMUP</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iter_warmup</span> <span class="o">=</span> <span class="n">iter_warmup</span>
        <span class="n">thin</span> <span class="o">=</span> <span class="n">sampler_args</span><span class="o">.</span><span class="n">thin</span>
        <span class="k">if</span> <span class="n">thin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thin</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_CMDSTAN_THIN</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thin</span> <span class="o">=</span> <span class="n">thin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_fixed_param</span> <span class="o">=</span> <span class="n">sampler_args</span><span class="o">.</span><span class="n">fixed_param</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_warmup</span> <span class="o">=</span> <span class="n">sampler_args</span><span class="o">.</span><span class="n">save_warmup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sig_figs</span> <span class="o">=</span> <span class="n">runset</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">sig_figs</span>
        <span class="c1"># info from CSV values, instantiated lazily</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(())</span>
        <span class="c1"># info from CSV initial comments and header</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_csv_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">:</span> <span class="n">InferenceMetadata</span> <span class="o">=</span> <span class="n">InferenceMetadata</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="nb">repr</span> <span class="o">=</span> <span class="s1">&#39;CmdStanMCMC: model=</span><span class="si">{}</span><span class="s1"> chains=</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">chains</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">method_args</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="p">[]),</span>
        <span class="p">)</span>
        <span class="nb">repr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1"> csv_files:</span><span class="se">\n\t</span><span class="si">{}</span><span class="se">\n</span><span class="s1"> output_files:</span><span class="se">\n\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">repr</span><span class="p">,</span>
            <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">csv_files</span><span class="p">),</span>
            <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">stdout_files</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># TODO - hamiltonian, profiling files</span>
        <span class="k">return</span> <span class="nb">repr</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chains</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Number of chains.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">chains</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chain_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Chain ids.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">chain_ids</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_draws_warmup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Number of warmup draws per chain, i.e., thinned warmup iterations.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_warmup</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thin</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_draws_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Number of sampling (post-warmup) draws per chain, i.e.,</span>
<span class="sd">        thinned sampling iterations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_sampling</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thin</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferenceMetadata</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns object which contains CmdStan configuration as well as</span>
<span class="sd">        information about the names and structure of the inference method</span>
<span class="sd">        and model output variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Names of all outputs from the sampler, comprising sampler parameters</span>
<span class="sd">        and all components of all model parameters, transformed parameters,</span>
<span class="sd">        and quantities of interest. Corresponds to Stan CSV file header row,</span>
<span class="sd">        with names munged to array notation, e.g. `beta[1]` not `beta.1`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">cmdstan_config</span><span class="p">[</span><span class="s1">&#39;column_names&#39;</span><span class="p">]</span>  <span class="c1"># type: ignore</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metric_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Metric type used for adaptation, either &#39;diag_e&#39; or &#39;dense_e&#39;.</span>
<span class="sd">        When sampler algorithm &#39;fixed_param&#39; is specified, metric_type is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_fixed_param</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># cmdstan arg name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">cmdstan_config</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>  <span class="c1"># type: ignore</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metric</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Metric used by sampler for each chain.</span>
<span class="sd">        When sampler algorithm &#39;fixed_param&#39; is specified, metric is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_fixed_param</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">cmdstan_config</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;unit_e&#39;</span><span class="p">:</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Unit diagnonal metric, inverse mass matrix size unknown.&#39;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_draws</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">step_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Step size used by sampler for each chain.</span>
<span class="sd">        When sampler algorithm &#39;fixed_param&#39; is specified, step size is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_fixed_param</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_size</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_draws</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_size</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">thin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Period between recorded iterations.  (Default is 1).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thin</span>

<div class="viewcode-block" id="CmdStanMCMC.draws"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanMCMC.draws">[docs]</a>    <span class="k">def</span> <span class="nf">draws</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">inc_warmup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">concat_chains</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a numpy.ndarray over all draws from all chains which is</span>
<span class="sd">        stored column major so that the values for a parameter are contiguous</span>
<span class="sd">        in memory, likewise all draws from a chain are contiguous.</span>
<span class="sd">        By default, returns a 3D array arranged (draws, chains, columns);</span>
<span class="sd">        parameter ``concat_chains=True`` will return a 2D array where all</span>
<span class="sd">        chains are flattened into a single column, preserving chain order,</span>
<span class="sd">        so that given M chains of N draws, the first N draws are from chain 1,</span>
<span class="sd">        up through the last N draws from chain M.</span>

<span class="sd">        :param inc_warmup: When ``True`` and the warmup draws are present in</span>
<span class="sd">            the output, i.e., the sampler was run with ``save_warmup=True``,</span>
<span class="sd">            then the warmup draws are included.  Default value is ``False``.</span>

<span class="sd">        :param concat_chains: When ``True`` return a 2D array flattening all</span>
<span class="sd">            all draws from all chains.  Default value is ``False``.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        CmdStanMCMC.draws_pd</span>
<span class="sd">        CmdStanMCMC.draws_xr</span>
<span class="sd">        CmdStanGQ.draws</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_draws</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">inc_warmup</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_warmup</span><span class="p">:</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Sample doesn&#39;t contain draws from warmup iterations,&quot;</span>
                <span class="s1">&#39; rerun sampler with &quot;save_warmup=True&quot;.&#39;</span>
            <span class="p">)</span>

        <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inc_warmup</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_warmup</span><span class="p">:</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_draws_warmup</span>

        <span class="k">if</span> <span class="n">concat_chains</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">flatten_chains</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_draws</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># type: ignore</span></div>

    <span class="k">def</span> <span class="nf">_validate_csv_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that Stan CSV output files for all chains are consistent</span>
<span class="sd">        and returns dict containing config and column names.</span>

<span class="sd">        Raises exception when inconsistencies detected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dzero</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dzero</span> <span class="o">=</span> <span class="n">check_sampler_csv</span><span class="p">(</span>
                    <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">csv_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">is_fixed_param</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_fixed_param</span><span class="p">,</span>
                    <span class="n">iter_sampling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_sampling</span><span class="p">,</span>
                    <span class="n">iter_warmup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_warmup</span><span class="p">,</span>
                    <span class="n">save_warmup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_warmup</span><span class="p">,</span>
                    <span class="n">thin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thin</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">drest</span> <span class="o">=</span> <span class="n">check_sampler_csv</span><span class="p">(</span>
                    <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">csv_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">is_fixed_param</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_fixed_param</span><span class="p">,</span>
                    <span class="n">iter_sampling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_sampling</span><span class="p">,</span>
                    <span class="n">iter_warmup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_warmup</span><span class="p">,</span>
                    <span class="n">save_warmup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_warmup</span><span class="p">,</span>
                    <span class="n">thin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thin</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dzero</span><span class="p">:</span>
                    <span class="c1"># check args that matter for parsing, plus name, version</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">key</span>
                        <span class="ow">in</span> <span class="p">[</span>
                            <span class="s1">&#39;stan_version_major&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;stan_version_minor&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;stan_version_patch&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;stanc_version&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;model&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;num_samples&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;num_warmup&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;save_warmup&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;thin&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;refresh&#39;</span><span class="p">,</span>
                        <span class="p">]</span>
                        <span class="ow">and</span> <span class="n">dzero</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">drest</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s1">&#39;CmdStan config mismatch in Stan CSV file </span><span class="si">{}</span><span class="s1">: &#39;</span>
                            <span class="s1">&#39;arg </span><span class="si">{}</span><span class="s1"> is </span><span class="si">{}</span><span class="s1">, expected </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">csv_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                <span class="n">key</span><span class="p">,</span>
                                <span class="n">dzero</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                                <span class="n">drest</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
        <span class="k">return</span> <span class="n">dzero</span>

    <span class="k">def</span> <span class="nf">_assemble_draws</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allocates and populates the step size, metric, and sample arrays</span>
<span class="sd">        by parsing the validated stan_csv files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,):</span>
            <span class="k">return</span>

        <span class="n">num_draws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_draws_sampling</span>
        <span class="n">sampling_iter_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_warmup</span><span class="p">:</span>
            <span class="n">num_draws</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_draws_warmup</span>
            <span class="n">sampling_iter_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_draws_warmup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
            <span class="p">(</span><span class="n">num_draws</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">)),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">csv_files</span><span class="p">[</span><span class="n">chain</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="c1"># read initial comments, CSV header row</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_fixed_param</span><span class="p">:</span>
                    <span class="c1"># handle warmup draws, if any</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_warmup</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_draws_warmup</span><span class="p">):</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="n">xs</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">&#39;# Adaptation terminated&#39;</span><span class="p">:</span>  <span class="c1"># shouldn&#39;t happen?</span>
                        <span class="k">while</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">&#39;# Adaptation terminated&#39;</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="c1"># step_size, metric (diag_e and dense_e only)</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">step_size</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_step_size</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">step_size</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">cmdstan_config</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;unit_e&#39;</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># metric type</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; #</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">num_unconstrained_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">chain</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># can&#39;t allocate w/o num params</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="o">==</span> <span class="s1">&#39;diag_e&#39;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
                                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">,</span> <span class="n">num_unconstrained_params</span><span class="p">),</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
                                    <span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">,</span>
                                        <span class="n">num_unconstrained_params</span><span class="p">,</span>
                                        <span class="n">num_unconstrained_params</span><span class="p">,</span>
                                    <span class="p">),</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                                <span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="o">==</span> <span class="s1">&#39;diag_e&#39;</span><span class="p">:</span>
                            <span class="n">xs</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">[</span><span class="n">chain</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">xs</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">[</span><span class="n">chain</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_unconstrained_params</span><span class="p">):</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; #</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="n">xs</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">[</span><span class="n">chain</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                                    <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span>
                                <span class="p">]</span>
                <span class="c1"># process draws</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sampling_iter_start</span><span class="p">,</span> <span class="n">num_draws</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">xs</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<div class="viewcode-block" id="CmdStanMCMC.summary"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanMCMC.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">percentiles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sig_figs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run cmdstan/bin/stansummary over all output CSV files, assemble</span>
<span class="sd">        summary into DataFrame object; first row contains summary statistics</span>
<span class="sd">        for total joint log probability `lp__`, remaining rows contain summary</span>
<span class="sd">        statistics for all parameters, transformed parameters, and generated</span>
<span class="sd">        quantities variables listed in the order in which they were declared</span>
<span class="sd">        in the Stan program.</span>

<span class="sd">        :param percentiles: Ordered non-empty list of percentiles to report.</span>
<span class="sd">            Must be integers from (1, 99), inclusive.</span>

<span class="sd">        :param sig_figs: Number of significant figures to report.</span>
<span class="sd">            Must be an integer between 1 and 18.  If unspecified, the default</span>
<span class="sd">            precision for the system file I/O is used; the usual value is 6.</span>
<span class="sd">            If precision above 6 is requested, sample must have been produced</span>
<span class="sd">            by CmdStan version 2.25 or later and sampler output precision</span>
<span class="sd">            must equal to or greater than the requested summary precision.</span>

<span class="sd">        :return: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">percentiles_str</span> <span class="o">=</span> <span class="s1">&#39;--percentiles=5,50,95&#39;</span>
        <span class="k">if</span> <span class="n">percentiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">percentiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Invalid percentiles argument, must be ordered&#39;</span>
                    <span class="s1">&#39; non-empty list from (1, 99), inclusive.&#39;</span>
                <span class="p">)</span>
            <span class="n">cur_pct</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">pct</span> <span class="ow">in</span> <span class="n">percentiles</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pct</span> <span class="o">&gt;</span> <span class="mi">99</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">pct</span> <span class="o">&gt;</span> <span class="n">cur_pct</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;Invalid percentiles spec, must be ordered&#39;</span>
                        <span class="s1">&#39; non-empty list from (1, 99), inclusive.&#39;</span>
                    <span class="p">)</span>
                <span class="n">cur_pct</span> <span class="o">=</span> <span class="n">pct</span>
            <span class="n">percentiles_str</span> <span class="o">=</span> <span class="s1">&#39;=&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;--percentiles&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">percentiles</span><span class="p">])]</span>
            <span class="p">)</span>
        <span class="n">sig_figs_str</span> <span class="o">=</span> <span class="s1">&#39;--sig_figs=2&#39;</span>
        <span class="k">if</span> <span class="n">sig_figs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sig_figs</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sig_figs</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">sig_figs</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Keyword &quot;sig_figs&quot; must be an integer between 1 and 18,&#39;</span>
                    <span class="s1">&#39; found </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sig_figs</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">csv_sig_figs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sig_figs</span> <span class="ow">or</span> <span class="mi">6</span>
            <span class="k">if</span> <span class="n">sig_figs</span> <span class="o">&gt;</span> <span class="n">csv_sig_figs</span><span class="p">:</span>
                <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;Requesting </span><span class="si">%d</span><span class="s1"> significant digits of output, but CSV files&#39;</span>
                    <span class="s1">&#39; only have </span><span class="si">%d</span><span class="s1"> digits of precision.&#39;</span><span class="p">,</span>
                    <span class="n">sig_figs</span><span class="p">,</span>
                    <span class="n">csv_sig_figs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">sig_figs_str</span> <span class="o">=</span> <span class="s1">&#39;--sig_figs=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sig_figs</span><span class="p">)</span>
        <span class="n">cmd_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">cmdstan_path</span><span class="p">(),</span> <span class="s1">&#39;bin&#39;</span><span class="p">,</span> <span class="s1">&#39;stansummary&#39;</span> <span class="o">+</span> <span class="n">EXTENSION</span>
        <span class="p">)</span>
        <span class="n">tmp_csv_file</span> <span class="o">=</span> <span class="s1">&#39;stansummary-</span><span class="si">{}</span><span class="s1">-&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>
        <span class="n">tmp_csv_path</span> <span class="o">=</span> <span class="n">create_named_text_file</span><span class="p">(</span>
            <span class="nb">dir</span><span class="o">=</span><span class="n">_TMPDIR</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">tmp_csv_file</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">name_only</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">csv_str</span> <span class="o">=</span> <span class="s1">&#39;--csv_filename=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmp_csv_path</span><span class="p">)</span>
        <span class="c1"># TODO: remove at some future release</span>
        <span class="k">if</span> <span class="n">cmdstan_version_before</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">24</span><span class="p">):</span>
            <span class="n">csv_str</span> <span class="o">=</span> <span class="s1">&#39;--csv_file=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmp_csv_path</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">cmd_path</span><span class="p">,</span>
            <span class="n">percentiles_str</span><span class="p">,</span>
            <span class="n">sig_figs_str</span><span class="p">,</span>
            <span class="n">csv_str</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">csv_files</span>
        <span class="n">do_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">fd_out</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_csv_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">summary_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">fd</span><span class="p">,</span>
                <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span>
                <span class="n">float_precision</span><span class="o">=</span><span class="s1">&#39;high&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;lp__&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">summary_data</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">summary_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span></div>

<div class="viewcode-block" id="CmdStanMCMC.diagnose"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanMCMC.diagnose">[docs]</a>    <span class="k">def</span> <span class="nf">diagnose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run cmdstan/bin/diagnose over all output CSV files,</span>
<span class="sd">        return console output.</span>

<span class="sd">        The diagnose utility reads the outputs of all chains</span>
<span class="sd">        and checks for the following potential problems:</span>

<span class="sd">        + Transitions that hit the maximum treedepth</span>
<span class="sd">        + Divergent transitions</span>
<span class="sd">        + Low E-BFMI values (sampler transitions HMC potential energy)</span>
<span class="sd">        + Low effective sample sizes</span>
<span class="sd">        + High R-hat values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmdstan_path</span><span class="p">(),</span> <span class="s1">&#39;bin&#39;</span><span class="p">,</span> <span class="s1">&#39;diagnose&#39;</span> <span class="o">+</span> <span class="n">EXTENSION</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd_path</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">csv_files</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">do_command</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">fd_out</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span></div>

<div class="viewcode-block" id="CmdStanMCMC.draws_pd"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanMCMC.draws_pd">[docs]</a>    <span class="k">def</span> <span class="nf">draws_pd</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">vars</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">inc_warmup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the sample draws as a pandas DataFrame.</span>
<span class="sd">        Flattens all chains into single column.  Container variables</span>
<span class="sd">        (array, vector, matrix) will span multiple columns, one column</span>
<span class="sd">        per element. E.g. variable &#39;matrix[2,2] foo&#39; spans 4 columns:</span>
<span class="sd">        &#39;foo[1,1], ... foo[2,2]&#39;.</span>

<span class="sd">        :param vars: optional list of variable names.</span>

<span class="sd">        :param inc_warmup: When ``True`` and the warmup draws are present in</span>
<span class="sd">            the output, i.e., the sampler was run with ``save_warmup=True``,</span>
<span class="sd">            then the warmup draws are included.  Default value is ``False``.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        CmdStanMCMC.draws</span>
<span class="sd">        CmdStanMCMC.draws_xr</span>
<span class="sd">        CmdStanGQ.draws_pd</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">vars</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">vars_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vars_list</span> <span class="o">=</span> <span class="nb">vars</span>

        <span class="k">if</span> <span class="n">inc_warmup</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_warmup</span><span class="p">:</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Draws from warmup iterations not available,&#39;</span>
                <span class="s1">&#39; must run sampler with &quot;save_warmup=True&quot;.&#39;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_draws</span><span class="p">()</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">vars_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">method_vars_cols</span>
                    <span class="ow">and</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown variable: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">method_vars_cols</span><span class="p">:</span>
                    <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
                        <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">flatten_chains</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">draws</span><span class="p">(</span><span class="n">inc_warmup</span><span class="o">=</span><span class="n">inc_warmup</span><span class="p">)),</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">,</span>
        <span class="p">)[</span><span class="n">cols</span><span class="p">]</span></div>

<div class="viewcode-block" id="CmdStanMCMC.draws_xr"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanMCMC.draws_xr">[docs]</a>    <span class="k">def</span> <span class="nf">draws_xr</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="nb">vars</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">inc_warmup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;xr.Dataset&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the sampler draws as a xarray Dataset.</span>

<span class="sd">        :param vars: optional list of variable names.</span>

<span class="sd">        :param inc_warmup: When ``True`` and the warmup draws are present in</span>
<span class="sd">            the output, i.e., the sampler was run with ``save_warmup=True``,</span>
<span class="sd">            then the warmup draws are included.  Default value is ``False``.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        CmdStanMCMC.draws</span>
<span class="sd">        CmdStanMCMC.draws_pd</span>
<span class="sd">        CmdStanGQ.draws_xr</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">XARRAY_INSTALLED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">&#39;Package &quot;xarray&quot; is not installed, cannot produce draws array.&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">inc_warmup</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_warmup</span><span class="p">:</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Draws from warmup iterations not available,&quot;</span>
                <span class="s1">&#39; must run sampler with &quot;save_warmup=True&quot;.&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">vars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vars_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">vars</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">vars_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vars_list</span> <span class="o">=</span> <span class="nb">vars</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_draws</span><span class="p">()</span>

        <span class="n">num_draws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_draws_sampling</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">cmdstan_config</span>
        <span class="n">attrs</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="n">Hashable</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;stan_version&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;stan_version_major&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;stan_version_minor&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;stan_version_patch&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span>
            <span class="s2">&quot;num_draws_sampling&quot;</span><span class="p">:</span> <span class="n">num_draws</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">inc_warmup</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_warmup</span><span class="p">:</span>
            <span class="n">num_draws</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_draws_warmup</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;num_draws_warmup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_draws_warmup</span>

        <span class="n">data</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="n">Hashable</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">coordinates</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="n">Hashable</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;chain&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_ids</span><span class="p">,</span>
            <span class="s2">&quot;draw&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_draws</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_list</span><span class="p">:</span>
            <span class="n">build_xarray_data</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">var</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_dims</span><span class="p">[</span><span class="n">var</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="p">[</span><span class="n">var</span><span class="p">],</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draws</span><span class="p">(</span><span class="n">inc_warmup</span><span class="o">=</span><span class="n">inc_warmup</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
            <span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="o">...</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CmdStanMCMC.stan_variable"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanMCMC.stan_variable">[docs]</a>    <span class="k">def</span> <span class="nf">stan_variable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">inc_warmup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a numpy.ndarray which contains the set of draws</span>
<span class="sd">        for the named Stan program variable.  Flattens the chains,</span>
<span class="sd">        leaving the draws in chain order.  The first array dimension,</span>
<span class="sd">        corresponds to number of draws or post-warmup draws in the sample,</span>
<span class="sd">        per argument ``inc_warmup``.  The remaining dimensions correspond to</span>
<span class="sd">        the shape of the Stan program variable.</span>

<span class="sd">        Underlyingly draws are in chain order, i.e., for a sample with</span>
<span class="sd">        N chains of M draws each, the first M array elements are from chain 1,</span>
<span class="sd">        the next M are from chain 2, and the last M elements are from chain N.</span>

<span class="sd">        * If the variable is a scalar variable, the return array has shape</span>
<span class="sd">          ( draws X chains, 1).</span>
<span class="sd">        * If the variable is a vector, the return array has shape</span>
<span class="sd">          ( draws X chains, len(vector))</span>
<span class="sd">        * If the variable is a matrix, the return array has shape</span>
<span class="sd">          ( draws X chains, size(dim 1) X size(dim 2) )</span>
<span class="sd">        * If the variable is an array with N dimensions, the return array</span>
<span class="sd">          has shape ( draws X chains, size(dim 1) X ... X size(dim N))</span>

<span class="sd">        For example, if the Stan program variable ``theta`` is a 3x3 matrix,</span>
<span class="sd">        and the sample consists of 4 chains with 1000 post-warmup draws,</span>
<span class="sd">        this function will return a numpy.ndarray with shape (4000,3,3).</span>

<span class="sd">        :param var: variable name</span>

<span class="sd">        :param inc_warmup: When ``True`` and the warmup draws are present in</span>
<span class="sd">            the output, i.e., the sampler was run with ``save_warmup=True``,</span>
<span class="sd">            then the warmup draws are included.  Default value is ``False``.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        CmdStanMCMC.stan_variables</span>
<span class="sd">        CmdStanMLE.stan_variable</span>
<span class="sd">        CmdStanVB.stan_variable</span>
<span class="sd">        CmdStanGQ.stan_variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No variable name specified.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_dims</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown variable name: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_draws</span><span class="p">()</span>
        <span class="n">draw1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inc_warmup</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_warmup</span><span class="p">:</span>
            <span class="n">draw1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_draws_warmup</span>
        <span class="n">num_draws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_draws_sampling</span>
        <span class="k">if</span> <span class="n">inc_warmup</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_warmup</span><span class="p">:</span>
            <span class="n">num_draws</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_draws_warmup</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">num_draws</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">]</span>
        <span class="n">col_idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_idxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dims</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_dims</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
        <span class="c1"># pylint: disable=redundant-keyword-arg</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span><span class="p">[</span><span class="n">draw1</span><span class="p">:,</span> <span class="p">:,</span> <span class="n">col_idxs</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">dims</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CmdStanMCMC.stan_variables"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanMCMC.stan_variables">[docs]</a>    <span class="k">def</span> <span class="nf">stan_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary mapping Stan program variables names</span>
<span class="sd">        to the corresponding numpy.ndarray containing the inferred values.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        CmdStanMCMC.stan_variable</span>
<span class="sd">        CmdStanMLE.stan_variables</span>
<span class="sd">        CmdStanVB.stan_variables</span>
<span class="sd">        CmdStanGQ.stan_variables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_dims</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stan_variable</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CmdStanMCMC.method_variables"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanMCMC.method_variables">[docs]</a>    <span class="k">def</span> <span class="nf">method_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary of all sampler variables, i.e., all</span>
<span class="sd">        output column names ending in `__`.  Assumes that all variables</span>
<span class="sd">        are scalar variables where column name is variable name.</span>
<span class="sd">        Maps each column name to a numpy.ndarray (draws x chains x 1)</span>
<span class="sd">        containing per-draw diagnostic values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_draws</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">method_vars_cols</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CmdStanMCMC.save_csvfiles"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanMCMC.save_csvfiles">[docs]</a>    <span class="k">def</span> <span class="nf">save_csvfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move output CSV files to specified directory.  If files were</span>
<span class="sd">        written to the temporary session directory, clean filename.</span>
<span class="sd">        E.g., save &#39;bernoulli-201912081451-1-5nm6as7u.csv&#39; as</span>
<span class="sd">        &#39;bernoulli-201912081451-1.csv&#39;.</span>

<span class="sd">        :param dir: directory path</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        stanfit.RunSet.save_csvfiles</span>
<span class="sd">        cmdstanpy.from_csv</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">save_csvfiles</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CmdStanMLE"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanMLE">[docs]</a><span class="k">class</span> <span class="nc">CmdStanMLE</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for outputs from CmdStan optimization.</span>
<span class="sd">    Created by :meth:`CmdStanModel.optimize`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runset</span><span class="p">:</span> <span class="n">RunSet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">runset</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Wrong runset method, expecting optimize runset, &#39;</span>
                <span class="s1">&#39;found method </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">runset</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runset</span> <span class="o">=</span> <span class="n">runset</span>
        <span class="c1"># info from runset to be exposed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converged</span> <span class="o">=</span> <span class="n">runset</span><span class="o">.</span><span class="n">_check_retcodes</span><span class="p">()</span>
        <span class="n">optimize_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">method_args</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">optimize_args</span><span class="p">,</span> <span class="n">OptimizeArgs</span>
        <span class="p">)</span>  <span class="c1"># make the typechecker happy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_iterations</span> <span class="o">=</span> <span class="n">optimize_args</span><span class="o">.</span><span class="n">save_iterations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_mle_attrs</span><span class="p">(</span><span class="n">runset</span><span class="o">.</span><span class="n">csv_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="nb">repr</span> <span class="o">=</span> <span class="s1">&#39;CmdStanMLE: model=</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">method_args</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="p">[])</span>
        <span class="p">)</span>
        <span class="nb">repr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1"> csv_file:</span><span class="se">\n\t</span><span class="si">{}</span><span class="se">\n</span><span class="s1"> output_file:</span><span class="se">\n\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">repr</span><span class="p">,</span>
            <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">csv_files</span><span class="p">),</span>
            <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">stdout_files</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
            <span class="nb">repr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1"> Warning: invalid estimate, &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">)</span>
            <span class="nb">repr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> optimization failed to converge.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">repr</span>

    <span class="k">def</span> <span class="nf">_set_mle_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_csv_0</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">scan_optimize_csv</span><span class="p">(</span><span class="n">sample_csv_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_iterations</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">InferenceMetadata</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_column_names</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;column_names&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;mle&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>  <span class="c1"># make the typechecker happy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mle</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;mle&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_iterations</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;all_iters&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
            <span class="p">)</span>  <span class="c1"># make the typechecker happy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_all_iters</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;all_iters&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Names of estimated quantities, includes joint log probability,</span>
<span class="sd">        and all parameters, transformed parameters, and generated quantities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_names</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferenceMetadata</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns object which contains CmdStan configuration as well as</span>
<span class="sd">        information about the names and structure of the inference method</span>
<span class="sd">        and model output variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">optimized_params_np</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns all final estimates from the optimizer as a numpy.ndarray</span>
<span class="sd">        which contains all optimizer outputs, i.e., the value for `lp__`</span>
<span class="sd">        as well as all Stan program variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Invalid estimate, optimization failed to converge.&#39;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mle</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">optimized_iterations_np</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns all saved iterations from the optimizer and final estimate</span>
<span class="sd">        as a numpy.ndarray which contains all optimizer outputs, i.e.,</span>
<span class="sd">        the value for `lp__` as well as all Stan program variables.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_iterations</span><span class="p">:</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Intermediate iterations not saved to CSV output file. &#39;</span>
                <span class="s1">&#39;Rerun the optimize method with &quot;save_iterations=True&quot;.&#39;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Invalid estimate, optimization failed to converge.&#39;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_iters</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">optimized_params_pd</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns all final estimates from the optimizer as a pandas.DataFrame</span>
<span class="sd">        which contains all optimizer outputs, i.e., the value for `lp__`</span>
<span class="sd">        as well as all Stan program variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">_check_retcodes</span><span class="p">():</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Invalid estimate, optimization failed to converge.&#39;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_mle</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">optimized_iterations_pd</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns all saved iterations from the optimizer and final estimate</span>
<span class="sd">        as a pandas.DataFrame which contains all optimizer outputs, i.e.,</span>
<span class="sd">        the value for `lp__` as well as all Stan program variables.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_iterations</span><span class="p">:</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Intermediate iterations not saved to CSV output file. &#39;</span>
                <span class="s1">&#39;Rerun the optimize method with &quot;save_iterations=True&quot;.&#39;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Invalid estimate, optimization failed to converge.&#39;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_iters</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">optimized_params_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns all estimates from the optimizer, including `lp__` as a</span>
<span class="sd">        Python Dict.  Only returns estimate from final iteration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">_check_retcodes</span><span class="p">():</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Invalid estimate, optimization failed to converge.&#39;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mle</span><span class="p">))</span>

<div class="viewcode-block" id="CmdStanMLE.stan_variable"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanMLE.stan_variable">[docs]</a>    <span class="k">def</span> <span class="nf">stan_variable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">inc_iterations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">warn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a numpy.ndarray which contains the estimates for the</span>
<span class="sd">        for the named Stan program variable where the dimensions of the</span>
<span class="sd">        numpy.ndarray match the shape of the Stan program variable.</span>

<span class="sd">        :param var: variable name</span>

<span class="sd">        :param inc_iterations: When ``True`` and the intermediate estimates</span>
<span class="sd">            are included in the output, i.e., the optimizer was run with</span>
<span class="sd">            ``save_iterations=True``, then intermediate estimates are included.</span>
<span class="sd">            Default value is ``False``.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        CmdStanMLE.stan_variables</span>
<span class="sd">        CmdStanMCMC.stan_variable</span>
<span class="sd">        CmdStanVB.stan_variable</span>
<span class="sd">        CmdStanGQ.stan_variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no variable name specified.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_dims</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown variable name: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">warn</span> <span class="ow">and</span> <span class="n">inc_iterations</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_iterations</span><span class="p">:</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Intermediate iterations not saved to CSV output file. &#39;</span>
                <span class="s1">&#39;Rerun the optimize method with &quot;save_iterations=True&quot;.&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">warn</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">_check_retcodes</span><span class="p">():</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Invalid estimate, optimization failed to converge.&#39;</span>
            <span class="p">)</span>

        <span class="n">col_idxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">inc_iterations</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_iterations</span><span class="p">:</span>
            <span class="n">num_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_iters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_rows</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_idxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># container var</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_rows</span><span class="p">,)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_dims</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="c1"># pylint: disable=redundant-keyword-arg</span>
            <span class="k">if</span> <span class="n">num_rows</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_iters</span><span class="p">[:,</span> <span class="n">col_idxs</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                    <span class="n">dims</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mle</span><span class="p">[</span><span class="n">col_idxs</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># scalar var</span>
            <span class="n">col_idx</span> <span class="o">=</span> <span class="n">col_idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">num_rows</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_iters</span><span class="p">[:,</span> <span class="n">col_idx</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mle</span><span class="p">[</span><span class="n">col_idx</span><span class="p">])</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># make the typechecker happy</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CmdStanMLE.stan_variables"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanMLE.stan_variables">[docs]</a>    <span class="k">def</span> <span class="nf">stan_variables</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">inc_iterations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary mapping Stan program variables names</span>
<span class="sd">        to the corresponding numpy.ndarray containing the inferred values.</span>

<span class="sd">        :param inc_iterations: When ``True`` and the intermediate estimates</span>
<span class="sd">            are included in the output, i.e., the optimizer was run with</span>
<span class="sd">            ``save_iterations=True``, then intermediate estimates are included.</span>
<span class="sd">            Default value is ``False``.</span>


<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        CmdStanMLE.stan_variable</span>
<span class="sd">        CmdStanMCMC.stan_variables</span>
<span class="sd">        CmdStanVB.stan_variables</span>
<span class="sd">        CmdStanGQ.stan_variables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">_check_retcodes</span><span class="p">():</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Invalid estimate, optimization failed to converge.&#39;</span>
            <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_dims</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stan_variable</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">inc_iterations</span><span class="o">=</span><span class="n">inc_iterations</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CmdStanMLE.save_csvfiles"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanMLE.save_csvfiles">[docs]</a>    <span class="k">def</span> <span class="nf">save_csvfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move output CSV files to specified directory.  If files were</span>
<span class="sd">        written to the temporary session directory, clean filename.</span>
<span class="sd">        E.g., save &#39;bernoulli-201912081451-1-5nm6as7u.csv&#39; as</span>
<span class="sd">        &#39;bernoulli-201912081451-1.csv&#39;.</span>

<span class="sd">        :param dir: directory path</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        stanfit.RunSet.save_csvfiles</span>
<span class="sd">        cmdstanpy.from_csv</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">save_csvfiles</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CmdStanGQ"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanGQ">[docs]</a><span class="k">class</span> <span class="nc">CmdStanGQ</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for outputs from CmdStan generate_quantities run.</span>
<span class="sd">    Created by :meth:`CmdStanModel.generate_quantities`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">runset</span><span class="p">:</span> <span class="n">RunSet</span><span class="p">,</span>
        <span class="n">mcmc_sample</span><span class="p">:</span> <span class="n">CmdStanMCMC</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">runset</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="n">GENERATE_QUANTITIES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Wrong runset method, expecting generate_quantities runset, &#39;</span>
                <span class="s1">&#39;found method </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">runset</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runset</span> <span class="o">=</span> <span class="n">runset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span> <span class="o">=</span> <span class="n">mcmc_sample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(())</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_csv_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">InferenceMetadata</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="nb">repr</span> <span class="o">=</span> <span class="s1">&#39;CmdStanGQ: model=</span><span class="si">{}</span><span class="s1"> chains=</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">method_args</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="p">[]),</span>
        <span class="p">)</span>
        <span class="nb">repr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1"> csv_files:</span><span class="se">\n\t</span><span class="si">{}</span><span class="se">\n</span><span class="s1"> output_files:</span><span class="se">\n\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">repr</span><span class="p">,</span>
            <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">csv_files</span><span class="p">),</span>
            <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">stdout_files</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">repr</span>

    <span class="k">def</span> <span class="nf">_validate_csv_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that Stan CSV output files for all chains are consistent</span>
<span class="sd">        and returns dict containing config and column names.</span>

<span class="sd">        Raises exception when inconsistencies detected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dzero</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dzero</span> <span class="o">=</span> <span class="n">scan_generated_quantities_csv</span><span class="p">(</span>
                    <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">csv_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">drest</span> <span class="o">=</span> <span class="n">scan_generated_quantities_csv</span><span class="p">(</span>
                    <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">csv_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dzero</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">key</span>
                        <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                            <span class="s1">&#39;id&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;fitted_params&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;diagnostic_file&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;metric_file&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;profile_file&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;init&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;seed&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;start_datetime&#39;</span><span class="p">,</span>
                        <span class="p">]</span>
                        <span class="ow">and</span> <span class="n">dzero</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">drest</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s1">&#39;CmdStan config mismatch in Stan CSV file </span><span class="si">{}</span><span class="s1">: &#39;</span>
                            <span class="s1">&#39;arg </span><span class="si">{}</span><span class="s1"> is </span><span class="si">{}</span><span class="s1">, expected </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">csv_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                <span class="n">key</span><span class="p">,</span>
                                <span class="n">dzero</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                                <span class="n">drest</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
        <span class="k">return</span> <span class="n">dzero</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chains</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Number of chains.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">chains</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chain_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Chain ids.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">chain_ids</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Names of generated quantities of interest.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">cmdstan_config</span><span class="p">[</span><span class="s1">&#39;column_names&#39;</span><span class="p">]</span>  <span class="c1"># type: ignore</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferenceMetadata</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns object which contains CmdStan configuration as well as</span>
<span class="sd">        information about the names and structure of the inference method</span>
<span class="sd">        and model output variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>

<div class="viewcode-block" id="CmdStanGQ.draws"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanGQ.draws">[docs]</a>    <span class="k">def</span> <span class="nf">draws</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">inc_warmup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">concat_chains</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">inc_sample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a numpy.ndarray over the generated quantities draws from</span>
<span class="sd">        all chains which is stored column major so that the values</span>
<span class="sd">        for a parameter are contiguous in memory, likewise all draws from</span>
<span class="sd">        a chain are contiguous.  By default, returns a 3D array arranged</span>
<span class="sd">        (draws, chains, columns); parameter ``concat_chains=True`` will</span>
<span class="sd">        return a 2D array where all chains are flattened into a single column,</span>
<span class="sd">        preserving chain order, so that given M chains of N draws,</span>
<span class="sd">        the first N draws are from chain 1, ..., and the the last N draws</span>
<span class="sd">        are from chain M.</span>

<span class="sd">        :param inc_warmup: When ``True`` and the warmup draws are present in</span>
<span class="sd">            the output, i.e., the sampler was run with ``save_warmup=True``,</span>
<span class="sd">            then the warmup draws are included.  Default value is ``False``.</span>

<span class="sd">        :param concat_chains: When ``True`` return a 2D array flattening all</span>
<span class="sd">            all draws from all chains.  Default value is ``False``.</span>

<span class="sd">        :param inc_sample: When ``True`` include all columns in the mcmc_sample</span>
<span class="sd">            draws array as well, excepting columns for variables already present</span>
<span class="sd">            in the generated quantities drawset. Default value is ``False``.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        CmdStanGQ.draws_pd</span>
<span class="sd">        CmdStanGQ.draws_xr</span>
<span class="sd">        CmdStanMCMC.draws</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_generated_quantities</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">inc_warmup</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">cmdstan_config</span><span class="p">[</span><span class="s1">&#39;save_warmup&#39;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Sample doesn&#39;t contain draws from warmup iterations,&quot;</span>
                <span class="s1">&#39; rerun sampler with &quot;save_warmup=True&quot;.&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">inc_sample</span><span class="p">:</span>
            <span class="n">cols_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">column_names</span>
            <span class="n">cols_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_names</span>
            <span class="n">dups</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">item</span>
                <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">Counter</span><span class="p">(</span><span class="n">cols_1</span> <span class="o">+</span> <span class="n">cols_2</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="p">]</span>
            <span class="n">drop_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">dup</span> <span class="ow">in</span> <span class="n">dups</span><span class="p">:</span>
                <span class="n">drop_cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="p">[</span><span class="n">dup</span><span class="p">])</span>

        <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">inc_warmup</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">cmdstan_config</span><span class="p">[</span><span class="s1">&#39;save_warmup&#39;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">num_draws_warmup</span>

        <span class="k">if</span> <span class="n">concat_chains</span> <span class="ow">and</span> <span class="n">inc_sample</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">flatten_chains</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">draws</span><span class="p">(),</span> <span class="n">drop_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)[</span><span class="n">start_idx</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">concat_chains</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">flatten_chains</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_draws</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:])</span>
        <span class="k">if</span> <span class="n">inc_sample</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">draws</span><span class="p">(),</span> <span class="n">drop_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)[</span><span class="n">start_idx</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># type: ignore</span></div>

<div class="viewcode-block" id="CmdStanGQ.draws_pd"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanGQ.draws_pd">[docs]</a>    <span class="k">def</span> <span class="nf">draws_pd</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">vars</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">inc_warmup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">inc_sample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the generated quantities draws as a pandas DataFrame.</span>
<span class="sd">        Flattens all chains into single column.  Container variables</span>
<span class="sd">        (array, vector, matrix) will span multiple columns, one column</span>
<span class="sd">        per element. E.g. variable &#39;matrix[2,2] foo&#39; spans 4 columns:</span>
<span class="sd">        &#39;foo[1,1], ... foo[2,2]&#39;.</span>

<span class="sd">        :param vars: optional list of variable names.</span>

<span class="sd">        :param inc_warmup: When ``True`` and the warmup draws are present in</span>
<span class="sd">            the output, i.e., the sampler was run with ``save_warmup=True``,</span>
<span class="sd">            then the warmup draws are included.  Default value is ``False``.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        CmdStanGQ.draws</span>
<span class="sd">        CmdStanGQ.draws_xr</span>
<span class="sd">        CmdStanMCMC.draws_pd</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">vars</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">vars_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vars_list</span> <span class="o">=</span> <span class="nb">vars</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">inc_warmup</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">cmdstan_config</span><span class="p">[</span><span class="s1">&#39;save_warmup&#39;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Draws from warmup iterations not available,&#39;</span>
                <span class="s1">&#39; must run sampler with &quot;save_warmup=True&quot;.&#39;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_generated_quantities</span><span class="p">()</span>

        <span class="n">gq_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mcmc_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">vars_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
                        <span class="n">gq_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">inc_sample</span>
                    <span class="ow">and</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span>
                <span class="p">):</span>
                    <span class="n">mcmc_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown variable: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gq_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inc_sample</span> <span class="ow">and</span> <span class="n">mcmc_vars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gq_cols</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">draws_pd</span><span class="p">(</span>
                            <span class="nb">vars</span><span class="o">=</span><span class="n">mcmc_vars</span><span class="p">,</span> <span class="n">inc_warmup</span><span class="o">=</span><span class="n">inc_warmup</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                            <span class="n">data</span><span class="o">=</span><span class="n">flatten_chains</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">draws</span><span class="p">(</span><span class="n">inc_warmup</span><span class="o">=</span><span class="n">inc_warmup</span><span class="p">)</span>
                            <span class="p">),</span>
                            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">,</span>
                        <span class="p">)[</span><span class="n">gq_cols</span><span class="p">],</span>
                    <span class="p">],</span>
                    <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">draws_pd</span><span class="p">(</span>
                    <span class="nb">vars</span><span class="o">=</span><span class="n">mcmc_vars</span><span class="p">,</span> <span class="n">inc_warmup</span><span class="o">=</span><span class="n">inc_warmup</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">inc_sample</span> <span class="ow">and</span> <span class="nb">vars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">column_names</span>
            <span class="n">cols_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_names</span>
            <span class="n">dups</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">item</span>
                <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">Counter</span><span class="p">(</span><span class="n">cols_1</span> <span class="o">+</span> <span class="n">cols_2</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">draws_pd</span><span class="p">(</span><span class="n">inc_warmup</span><span class="o">=</span><span class="n">inc_warmup</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">dups</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">flatten_chains</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">draws</span><span class="p">(</span><span class="n">inc_warmup</span><span class="o">=</span><span class="n">inc_warmup</span><span class="p">)),</span>
                        <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">,</span>
                <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">gq_cols</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">flatten_chains</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">draws</span><span class="p">(</span><span class="n">inc_warmup</span><span class="o">=</span><span class="n">inc_warmup</span><span class="p">)),</span>
                <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">,</span>
            <span class="p">)[</span><span class="n">gq_cols</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">flatten_chains</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">draws</span><span class="p">(</span><span class="n">inc_warmup</span><span class="o">=</span><span class="n">inc_warmup</span><span class="p">)),</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CmdStanGQ.draws_xr"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanGQ.draws_xr">[docs]</a>    <span class="k">def</span> <span class="nf">draws_xr</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">vars</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">inc_warmup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">inc_sample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;xr.Dataset&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the generated quantities draws as a xarray Dataset.</span>

<span class="sd">        :param vars: optional list of variable names.</span>

<span class="sd">        :param inc_warmup: When ``True`` and the warmup draws are present in</span>
<span class="sd">            the MCMC sample, then the warmup draws are included.</span>
<span class="sd">            Default value is ``False``.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        CmdStanGQ.draws</span>
<span class="sd">        CmdStanGQ.draws_pd</span>
<span class="sd">        CmdStanMCMC.draws_xr</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">XARRAY_INSTALLED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">&#39;Package &quot;xarray&quot; is not installed, cannot produce draws array.&#39;</span>
            <span class="p">)</span>
        <span class="n">mcmc_vars_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dup_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">vars</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">vars_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vars_list</span> <span class="o">=</span> <span class="nb">vars</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inc_sample</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span>
                    <span class="p">):</span>
                        <span class="n">mcmc_vars_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                        <span class="n">dup_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown variable: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vars_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">inc_sample</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vars_list</span> <span class="ow">and</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mcmc_vars_list</span><span class="p">:</span>
                        <span class="n">mcmc_vars_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">dup_vars</span><span class="p">:</span>
            <span class="n">vars_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_generated_quantities</span><span class="p">()</span>

        <span class="n">num_draws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">num_draws_sampling</span>
        <span class="n">sample_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">cmdstan_config</span>
        <span class="n">attrs</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="n">Hashable</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;stan_version&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sample_config</span><span class="p">[</span><span class="s1">&#39;stan_version_major&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sample_config</span><span class="p">[</span><span class="s1">&#39;stan_version_minor&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sample_config</span><span class="p">[</span><span class="s1">&#39;stan_version_patch&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">sample_config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span>
            <span class="s2">&quot;num_draws_sampling&quot;</span><span class="p">:</span> <span class="n">num_draws</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">inc_warmup</span> <span class="ow">and</span> <span class="n">sample_config</span><span class="p">[</span><span class="s1">&#39;save_warmup&#39;</span><span class="p">]:</span>
            <span class="n">num_draws</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">num_draws_warmup</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;num_draws_warmup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">num_draws_warmup</span>

        <span class="n">data</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="n">Hashable</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">coordinates</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="n">Hashable</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;chain&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_ids</span><span class="p">,</span>
            <span class="s2">&quot;draw&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_draws</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_list</span><span class="p">:</span>
            <span class="n">build_xarray_data</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">var</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_dims</span><span class="p">[</span><span class="n">var</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="p">[</span><span class="n">var</span><span class="p">],</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draws</span><span class="p">(</span><span class="n">inc_warmup</span><span class="o">=</span><span class="n">inc_warmup</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">inc_sample</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">mcmc_vars_list</span><span class="p">:</span>
                <span class="n">build_xarray_data</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">,</span>
                    <span class="n">var</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">stan_vars_dims</span><span class="p">[</span><span class="n">var</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="p">[</span><span class="n">var</span><span class="p">],</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">draws</span><span class="p">(</span><span class="n">inc_warmup</span><span class="o">=</span><span class="n">inc_warmup</span><span class="p">),</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
            <span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="o">...</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CmdStanGQ.stan_variable"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanGQ.stan_variable">[docs]</a>    <span class="k">def</span> <span class="nf">stan_variable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">inc_warmup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a numpy.ndarray which contains the set of draws</span>
<span class="sd">        for the named Stan program variable.  Flattens the chains,</span>
<span class="sd">        leaving the draws in chain order.  The first array dimension,</span>
<span class="sd">        corresponds to number of draws in the sample.</span>
<span class="sd">        The remaining dimensions correspond to</span>
<span class="sd">        the shape of the Stan program variable.</span>

<span class="sd">        Underlyingly draws are in chain order, i.e., for a sample with</span>
<span class="sd">        N chains of M draws each, the first M array elements are from chain 1,</span>
<span class="sd">        the next M are from chain 2, and the last M elements are from chain N.</span>

<span class="sd">        * If the variable is a scalar variable, the return array has shape</span>
<span class="sd">          ( draws X chains, 1).</span>
<span class="sd">        * If the variable is a vector, the return array has shape</span>
<span class="sd">          ( draws X chains, len(vector))</span>
<span class="sd">        * If the variable is a matrix, the return array has shape</span>
<span class="sd">          ( draws X chains, size(dim 1) X size(dim 2) )</span>
<span class="sd">        * If the variable is an array with N dimensions, the return array</span>
<span class="sd">          has shape ( draws X chains, size(dim 1) X ... X size(dim N))</span>

<span class="sd">        For example, if the Stan program variable ``theta`` is a 3x3 matrix,</span>
<span class="sd">        and the sample consists of 4 chains with 1000 post-warmup draws,</span>
<span class="sd">        this function will return a numpy.ndarray with shape (4000,3,3).</span>

<span class="sd">        :param var: variable name</span>

<span class="sd">        :param inc_warmup: When ``True`` and the warmup draws are present in</span>
<span class="sd">            the MCMC sample, then the warmup draws are included.</span>
<span class="sd">            Default value is ``False``.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        CmdStanGQ.stan_variables</span>
<span class="sd">        CmdStanMCMC.stan_variable</span>
<span class="sd">        CmdStanMLE.stan_variable</span>
<span class="sd">        CmdStanVB.stan_variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No variable name specified.&#39;</span><span class="p">)</span>
        <span class="n">model_var_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">gq_var_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">var</span> <span class="ow">in</span> <span class="n">model_var_names</span> <span class="ow">or</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">gq_var_names</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown variable name: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gq_var_names</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">stan_variable</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">inc_warmup</span><span class="o">=</span><span class="n">inc_warmup</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># is gq variable</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_generated_quantities</span><span class="p">()</span>
            <span class="n">draw1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">inc_warmup</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">cmdstan_config</span><span class="p">[</span><span class="s1">&#39;save_warmup&#39;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">draw1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">num_draws_warmup</span>
            <span class="n">num_draws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">num_draws_sampling</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">inc_warmup</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">cmdstan_config</span><span class="p">[</span><span class="s1">&#39;save_warmup&#39;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">num_draws</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">num_draws_warmup</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">num_draws</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">]</span>
            <span class="n">col_idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_idxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dims</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_dims</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
            <span class="c1"># pylint: disable=redundant-keyword-arg</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span><span class="p">[</span><span class="n">draw1</span><span class="p">:,</span> <span class="p">:,</span> <span class="n">col_idxs</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="n">dims</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="CmdStanGQ.stan_variables"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanGQ.stan_variables">[docs]</a>    <span class="k">def</span> <span class="nf">stan_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inc_warmup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary mapping Stan program variables names</span>
<span class="sd">        to the corresponding numpy.ndarray containing the inferred values.</span>

<span class="sd">        :param inc_warmup: When ``True`` and the warmup draws are present in</span>
<span class="sd">            the MCMC sample, then the warmup draws are included.</span>
<span class="sd">            Default value is ``False``</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        CmdStanGQ.stan_variable</span>
<span class="sd">        CmdStanMCMC.stan_variables</span>
<span class="sd">        CmdStanMLE.stan_variables</span>
<span class="sd">        CmdStanVB.stan_variables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sample_var_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">gq_var_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">gq_var_names</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stan_variable</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">inc_warmup</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">sample_var_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gq_var_names</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stan_variable</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">inc_warmup</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="k">def</span> <span class="nf">_assemble_generated_quantities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># use numpy genfromtext</span>
        <span class="n">warmup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">cmdstan_config</span><span class="p">[</span><span class="s1">&#39;save_warmup&#39;</span><span class="p">]</span>
        <span class="n">num_draws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_sample</span><span class="o">.</span><span class="n">draws</span><span class="p">(</span><span class="n">inc_warmup</span><span class="o">=</span><span class="n">warmup</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">gq_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
            <span class="p">(</span><span class="n">num_draws</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">)),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">csv_files</span><span class="p">[</span><span class="n">chain</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fd</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">))</span>
                <span class="n">gq_sample</span><span class="p">[:,</span> <span class="n">chain</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span>
                    <span class="n">lines</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_draws</span> <span class="o">=</span> <span class="n">gq_sample</span>

<div class="viewcode-block" id="CmdStanGQ.save_csvfiles"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanGQ.save_csvfiles">[docs]</a>    <span class="k">def</span> <span class="nf">save_csvfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move output CSV files to specified directory.  If files were</span>
<span class="sd">        written to the temporary session directory, clean filename.</span>
<span class="sd">        E.g., save &#39;bernoulli-201912081451-1-5nm6as7u.csv&#39; as</span>
<span class="sd">        &#39;bernoulli-201912081451-1.csv&#39;.</span>

<span class="sd">        :param dir: directory path</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        stanfit.RunSet.save_csvfiles</span>
<span class="sd">        cmdstanpy.from_csv</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">save_csvfiles</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CmdStanVB"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanVB">[docs]</a><span class="k">class</span> <span class="nc">CmdStanVB</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for outputs from CmdStan variational run.</span>
<span class="sd">    Created by :meth:`CmdStanModel.variational`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runset</span><span class="p">:</span> <span class="n">RunSet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">runset</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="n">VARIATIONAL</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Wrong runset method, expecting variational inference, &#39;</span>
                <span class="s1">&#39;found method </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">runset</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runset</span> <span class="o">=</span> <span class="n">runset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_variational_attrs</span><span class="p">(</span><span class="n">runset</span><span class="o">.</span><span class="n">csv_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="nb">repr</span> <span class="o">=</span> <span class="s1">&#39;CmdStanVB: model=</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">method_args</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="p">[])</span>
        <span class="p">)</span>
        <span class="nb">repr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1"> csv_file:</span><span class="se">\n\t</span><span class="si">{}</span><span class="se">\n</span><span class="s1"> output_file:</span><span class="se">\n\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">repr</span><span class="p">,</span>
            <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">csv_files</span><span class="p">),</span>
            <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">stdout_files</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># TODO - diagnostic, profiling files</span>
        <span class="k">return</span> <span class="nb">repr</span>

    <span class="k">def</span> <span class="nf">_set_variational_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_csv_0</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">scan_variational_csv</span><span class="p">(</span><span class="n">sample_csv_0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">InferenceMetadata</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
        <span class="c1"># these three assignments don&#39;t grant type information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_column_names</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;column_names&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_variational_mean</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;variational_mean&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_variational_sample</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;variational_sample&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Total number of information items returned by sampler.</span>
<span class="sd">        Includes approximation information and names of model parameters</span>
<span class="sd">        and computed quantities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_column_names</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Names of information items returned by sampler for each draw.</span>
<span class="sd">        Includes approximation information and names of model parameters</span>
<span class="sd">        and computed quantities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_names</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Step size scaling parameter &#39;eta&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eta</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">variational_params_np</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns inferred parameter means as numpy array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variational_mean</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">variational_params_pd</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns inferred parameter means as pandas DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_variational_mean</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">variational_params_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Returns inferred parameter means as Dict.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variational_mean</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferenceMetadata</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns object which contains CmdStan configuration as well as</span>
<span class="sd">        information about the names and structure of the inference method</span>
<span class="sd">        and model output variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>

<div class="viewcode-block" id="CmdStanVB.stan_variable"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanVB.stan_variable">[docs]</a>    <span class="k">def</span> <span class="nf">stan_variable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a numpy.ndarray which contains the estimates for the</span>
<span class="sd">        for the named Stan program variable where the dimensions of the</span>
<span class="sd">        numpy.ndarray match the shape of the Stan program variable.</span>

<span class="sd">        :param var: variable name</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        CmdStanVB.stan_variables</span>
<span class="sd">        CmdStanMCMC.stan_variable</span>
<span class="sd">        CmdStanMLE.stan_variable</span>
<span class="sd">        CmdStanGQ.stan_variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No variable name specified.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_dims</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown variable name: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
        <span class="n">col_idxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_cols</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
        <span class="n">shape</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_idxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_dims</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_variational_mean</span><span class="p">)[</span><span class="n">col_idxs</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">shape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_variational_mean</span><span class="p">[</span><span class="n">col_idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CmdStanVB.stan_variables"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanVB.stan_variables">[docs]</a>    <span class="k">def</span> <span class="nf">stan_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary mapping Stan program variables names</span>
<span class="sd">        to the corresponding numpy.ndarray containing the inferred values.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        CmdStanVB.stan_variable</span>
<span class="sd">        CmdStanMCMC.stan_variables</span>
<span class="sd">        CmdStanMLE.stan_variables</span>
<span class="sd">        CmdStanGQ.stan_variables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">stan_vars_dims</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stan_variable</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">variational_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns the set of approximate posterior output draws.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variational_sample</span>

<div class="viewcode-block" id="CmdStanVB.save_csvfiles"><a class="viewcode-back" href="../../api.html#cmdstanpy.CmdStanVB.save_csvfiles">[docs]</a>    <span class="k">def</span> <span class="nf">save_csvfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move output CSV files to specified directory.  If files were</span>
<span class="sd">        written to the temporary session directory, clean filename.</span>
<span class="sd">        E.g., save &#39;bernoulli-201912081451-1-5nm6as7u.csv&#39; as</span>
<span class="sd">        &#39;bernoulli-201912081451-1.csv&#39;.</span>

<span class="sd">        :param dir: directory path</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        stanfit.RunSet.save_csvfiles</span>
<span class="sd">        cmdstanpy.from_csv</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runset</span><span class="o">.</span><span class="n">save_csvfiles</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="from_csv"><a class="viewcode-back" href="../../api.html#cmdstanpy.from_csv">[docs]</a><span class="k">def</span> <span class="nf">from_csv</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">CmdStanMCMC</span><span class="p">,</span> <span class="n">CmdStanMLE</span><span class="p">,</span> <span class="n">CmdStanVB</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instantiate a CmdStan object from a the Stan CSV files from a CmdStan run.</span>
<span class="sd">    CSV files are specified from either a list of Stan CSV files or a single</span>
<span class="sd">    filepath which can be either a directory name, a Stan CSV filename, or</span>
<span class="sd">    a pathname pattern (i.e., a Python glob).  The optional argument &#39;method&#39;</span>
<span class="sd">    checks that the CSV files were produced by that method.</span>
<span class="sd">    Stan CSV files from CmdStan methods &#39;sample&#39;, &#39;optimize&#39;, and &#39;variational&#39;</span>
<span class="sd">    result in objects of class CmdStanMCMC, CmdStanMLE, and CmdStanVB,</span>
<span class="sd">    respectively.</span>

<span class="sd">    :param path: directory path</span>
<span class="sd">    :param method: method name (optional)</span>

<span class="sd">    :return: either a CmdStanMCMC, CmdStanMLE, or CmdStanVB object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must specify path to Stan CSV files.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s1">&#39;sample&#39;</span><span class="p">,</span>
        <span class="s1">&#39;optimize&#39;</span><span class="p">,</span>
        <span class="s1">&#39;variational&#39;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Bad method argument </span><span class="si">{}</span><span class="s1">, must be one of: &#39;</span>
            <span class="s1">&#39;&quot;sample&quot;, &quot;optimize&quot;, &quot;variational&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">csvfiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">csvfiles</span> <span class="o">=</span> <span class="n">path</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">splits</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;Invalid path specification, </span><span class="si">{}</span><span class="s1"> &#39;</span>
                        <span class="s1">&#39; unknown directory: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">)</span>
            <span class="n">csvfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
                    <span class="n">csvfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">csvfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid path specification: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid path specification: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">csvfiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No CSV files found in directory </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">csvfiles</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Bad CSV file path spec,&#39;</span>
                <span class="s1">&#39; includes non-csv file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="n">config_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csvfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">scan_config</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="ne">PermissionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot read CSV file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csvfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_dict</span> <span class="ow">or</span> <span class="s1">&#39;method&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">{}</span><span class="s2"> is not a Stan CSV file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csvfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">method</span> <span class="o">!=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Expecting Stan CSV output files from method </span><span class="si">{}</span><span class="s1">, &#39;</span>
            <span class="s1">&#39; found outputs from method </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">method</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sample&#39;</span><span class="p">:</span>
            <span class="n">chains</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">csvfiles</span><span class="p">)</span>
            <span class="n">sampler_args</span> <span class="o">=</span> <span class="n">SamplerArgs</span><span class="p">(</span>
                <span class="n">iter_sampling</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;num_samples&#39;</span><span class="p">],</span>
                <span class="n">iter_warmup</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;num_warmup&#39;</span><span class="p">],</span>
                <span class="n">thin</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;thin&#39;</span><span class="p">],</span>
                <span class="n">save_warmup</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;save_warmup&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="c1"># bugfix 425, check for fixed_params output</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">check_sampler_csv</span><span class="p">(</span>
                    <span class="n">csvfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">iter_sampling</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;num_samples&#39;</span><span class="p">],</span>
                    <span class="n">iter_warmup</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;num_warmup&#39;</span><span class="p">],</span>
                    <span class="n">thin</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;thin&#39;</span><span class="p">],</span>
                    <span class="n">save_warmup</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;save_warmup&#39;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">check_sampler_csv</span><span class="p">(</span>
                        <span class="n">csvfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">is_fixed_param</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">iter_sampling</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;num_samples&#39;</span><span class="p">],</span>
                        <span class="n">iter_warmup</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;num_warmup&#39;</span><span class="p">],</span>
                        <span class="n">thin</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;thin&#39;</span><span class="p">],</span>
                        <span class="n">save_warmup</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;save_warmup&#39;</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="n">sampler_args</span> <span class="o">=</span> <span class="n">SamplerArgs</span><span class="p">(</span>
                        <span class="n">iter_sampling</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;num_samples&#39;</span><span class="p">],</span>
                        <span class="n">iter_warmup</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;num_warmup&#39;</span><span class="p">],</span>
                        <span class="n">thin</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;thin&#39;</span><span class="p">],</span>
                        <span class="n">save_warmup</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;save_warmup&#39;</span><span class="p">],</span>
                        <span class="n">fixed_param</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;Invalid or corrupt Stan CSV output file, &#39;</span>
                    <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

            <span class="n">cmdstan_args</span> <span class="o">=</span> <span class="n">CmdStanArgs</span><span class="p">(</span>
                <span class="n">model_name</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
                <span class="n">model_exe</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
                <span class="n">chain_ids</span><span class="o">=</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">chains</span><span class="p">)],</span>
                <span class="n">method_args</span><span class="o">=</span><span class="n">sampler_args</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">runset</span> <span class="o">=</span> <span class="n">RunSet</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">cmdstan_args</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="n">chains</span><span class="p">)</span>
            <span class="n">runset</span><span class="o">.</span><span class="n">_csv_files</span> <span class="o">=</span> <span class="n">csvfiles</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">runset</span><span class="o">.</span><span class="n">_retcodes</span><span class="p">)):</span>
                <span class="n">runset</span><span class="o">.</span><span class="n">_set_retcode</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">fit</span> <span class="o">=</span> <span class="n">CmdStanMCMC</span><span class="p">(</span><span class="n">runset</span><span class="p">)</span>
            <span class="n">fit</span><span class="o">.</span><span class="n">draws</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">fit</span>
        <span class="k">elif</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;optimize&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;algorithm&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot find optimization algorithm&quot;</span>
                    <span class="s2">&quot; in file </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csvfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="n">optimize_args</span> <span class="o">=</span> <span class="n">OptimizeArgs</span><span class="p">(</span>
                <span class="n">algorithm</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">],</span>
                <span class="n">save_iterations</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;save_iterations&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">cmdstan_args</span> <span class="o">=</span> <span class="n">CmdStanArgs</span><span class="p">(</span>
                <span class="n">model_name</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
                <span class="n">model_exe</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
                <span class="n">chain_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">method_args</span><span class="o">=</span><span class="n">optimize_args</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">runset</span> <span class="o">=</span> <span class="n">RunSet</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">cmdstan_args</span><span class="p">)</span>
            <span class="n">runset</span><span class="o">.</span><span class="n">_csv_files</span> <span class="o">=</span> <span class="n">csvfiles</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">runset</span><span class="o">.</span><span class="n">_retcodes</span><span class="p">)):</span>
                <span class="n">runset</span><span class="o">.</span><span class="n">_set_retcode</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">CmdStanMLE</span><span class="p">(</span><span class="n">runset</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;variational&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;algorithm&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot find variational algorithm&quot;</span>
                    <span class="s2">&quot; in file </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csvfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="n">variational_args</span> <span class="o">=</span> <span class="n">VariationalArgs</span><span class="p">(</span>
                <span class="n">algorithm</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">],</span>
                <span class="nb">iter</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;iter&#39;</span><span class="p">],</span>
                <span class="n">grad_samples</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;grad_samples&#39;</span><span class="p">],</span>
                <span class="n">elbo_samples</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;elbo_samples&#39;</span><span class="p">],</span>
                <span class="n">eta</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">],</span>
                <span class="n">tol_rel_obj</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;tol_rel_obj&#39;</span><span class="p">],</span>
                <span class="n">eval_elbo</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;eval_elbo&#39;</span><span class="p">],</span>
                <span class="n">output_samples</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;output_samples&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">cmdstan_args</span> <span class="o">=</span> <span class="n">CmdStanArgs</span><span class="p">(</span>
                <span class="n">model_name</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
                <span class="n">model_exe</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
                <span class="n">chain_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">method_args</span><span class="o">=</span><span class="n">variational_args</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">runset</span> <span class="o">=</span> <span class="n">RunSet</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">cmdstan_args</span><span class="p">)</span>
            <span class="n">runset</span><span class="o">.</span><span class="n">_csv_files</span> <span class="o">=</span> <span class="n">csvfiles</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">runset</span><span class="o">.</span><span class="n">_retcodes</span><span class="p">)):</span>
                <span class="n">runset</span><span class="o">.</span><span class="n">_set_retcode</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">CmdStanVB</span><span class="p">(</span><span class="n">runset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Unable to process CSV output files from method </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="ne">PermissionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;An error occured processing the CSV files:</span><span class="se">\n\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span></div>


<span class="k">def</span> <span class="nf">build_xarray_data</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="n">Hashable</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span>
    <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">dims</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
    <span class="n">col_idxs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
    <span class="n">start_row</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">drawset</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds Stan variable name, labels, and values to a dictionary</span>
<span class="sd">    that will be used to construct an xarray DataSet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">var_dims</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;chain&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dims</span><span class="p">:</span>
        <span class="n">var_dims</span> <span class="o">+=</span> <span class="nb">tuple</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_dim_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)))</span>
        <span class="n">data</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">var_dims</span><span class="p">,</span>
            <span class="n">drawset</span><span class="p">[</span><span class="n">start_row</span><span class="p">:,</span> <span class="p">:,</span> <span class="n">col_idxs</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="o">*</span><span class="n">drawset</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="o">*</span><span class="n">dims</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">var_dims</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">drawset</span><span class="p">[</span><span class="n">start_row</span><span class="p">:,</span> <span class="p">:,</span> <span class="n">col_idxs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">)</span>
</pre></div>

              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, Stan Development Team.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>